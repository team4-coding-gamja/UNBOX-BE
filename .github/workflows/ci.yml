name: CI Pipeline

on:
  push:
    branches: [develop, staging, main]
  pull_request:
    branches: [develop, staging, main]

env:
  AWS_REGION: ap-northeast-2
  ECR_REGISTRY: ${{ secrets.ECR_REGISTRY }}  # ECR 레지스트리 URL (123456789012.dkr.ecr.ap-northeast-2.amazonaws.com)

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run tests for Core Business Service
        run: ./gradlew :core-business:test

      - name: Run tests for Product Service
        run: ./gradlew :product-service:test

      - name: Generate test report
        uses: dorny/test-reporter@v1
        if: success() || failure()
        with:
          name: Gradle Tests
          path: '**/build/test-results/test/TEST-*.xml'
          reporter: java-junit

  build-and-push:
    name: Build and Push Docker Images
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push'  # PR에서는 빌드하지 않음
    
    strategy:
      matrix:
        service: [core-business, product-service]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Extract metadata
        id: meta
        run: |
          echo "image-tag=${GITHUB_SHA::8}" >> $GITHUB_OUTPUT
          echo "branch-name=${GITHUB_REF#refs/heads/}" >> $GITHUB_OUTPUT
          echo "timestamp=$(date +%Y%m%d-%H%M%S)" >> $GITHUB_OUTPUT

      - name: Build Docker image for ${{ matrix.service }}
        run: |
          docker build \
            -f ${{ matrix.service }}/Dockerfile \
            -t ${{ env.ECR_REGISTRY }}/unbox-${{ matrix.service }}:latest \
            -t ${{ env.ECR_REGISTRY }}/unbox-${{ matrix.service }}:${{ steps.meta.outputs.image-tag }} \
            -t ${{ env.ECR_REGISTRY }}/unbox-${{ matrix.service }}:${{ steps.meta.outputs.branch-name }}-${{ steps.meta.outputs.timestamp }} \
            .

      - name: Run security scan with Trivy
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.ECR_REGISTRY }}/unbox-${{ matrix.service }}:latest
          format: 'sarif'
          output: 'trivy-results-${{ matrix.service }}.sarif'

      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results-${{ matrix.service }}.sarif'

      - name: Push Docker image to ECR
        run: |
          docker push ${{ env.ECR_REGISTRY }}/unbox-${{ matrix.service }}:latest
          docker push ${{ env.ECR_REGISTRY }}/unbox-${{ matrix.service }}:${{ steps.meta.outputs.image-tag }}
          docker push ${{ env.ECR_REGISTRY }}/unbox-${{ matrix.service }}:${{ steps.meta.outputs.branch-name }}-${{ steps.meta.outputs.timestamp }}

      - name: Image digest
        run: |
          echo "Image pushed to ECR:"
          echo "Repository: ${{ env.ECR_REGISTRY }}/unbox-${{ matrix.service }}"
          echo "Tags: latest, ${{ steps.meta.outputs.image-tag }}, ${{ steps.meta.outputs.branch-name }}-${{ steps.meta.outputs.timestamp }}"

  notify:
    name: Notify Build Status
    runs-on: ubuntu-latest
    needs: [test, build-and-push]
    if: always()
    
    steps:
      - name: Notify success
        if: needs.test.result == 'success' && needs.build-and-push.result == 'success'
        run: |
          echo "✅ CI Pipeline completed successfully!"
          echo "Branch: ${GITHUB_REF#refs/heads/}"
          echo "Commit: ${GITHUB_SHA::8}"
          echo "Images pushed to ECR with tags: latest, ${GITHUB_SHA::8}"

      - name: Notify failure
        if: needs.test.result == 'failure' || needs.build-and-push.result == 'failure'
        run: |
          echo "❌ CI Pipeline failed!"
          echo "Branch: ${GITHUB_REF#refs/heads/}"
          echo "Commit: ${GITHUB_SHA::8}"
          exit 1