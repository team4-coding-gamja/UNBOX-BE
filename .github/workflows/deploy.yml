name: UNBOX Complete CI/CD Pipeline

on:
  push:
    branches: [ main, develop, feat/infra ]
    pull_request:
      branches: [ develop ]
    workflow_dispatch:
      inputs:
        destroy_infrastructure:
          description: 'Destroy infrastructure after deployment'
          required: false
          default: 'false'
          type: boolean

env:
  AWS_REGION: ap-northeast-2
  TERRAFORM_VERSION: 1.5.0
  DOCKER_IMAGE: gahyunsong/unbox-backend-v2

jobs:
  # ë³€ê²½ì‚¬í•­ ê°ì§€
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      terraform-changed: ${{ steps.changes.outputs.terraform }}
      app-changed: ${{ steps.changes.outputs.app }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2
      
      - uses: dorny/paths-filter@v2
        id: changes
        with:
          filters: |
            terraform:
              - 'terraform/**'
            app:
              - 'src/**'
              - 'build.gradle'
              - 'Dockerfile'
              - 'docker-compose*.yml'

  # Docker ì´ë¯¸ì§€ ë¹Œë“œ & í‘¸ì‹œ
  build-and-push:
    needs: detect-changes
    if: needs.detect-changes.outputs.app-changed == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
      
      - name: Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-
      
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
      
      - name: Build with Gradle
        run: ./gradlew bootJar --no-daemon
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}
      
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_IMAGE }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix={{branch}}-
            type=raw,value=latest
      
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # Terraform ê³„íš ìˆ˜ë¦½
  terraform-plan:
    needs: detect-changes
    if: needs.detect-changes.outputs.terraform-changed == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: terraform/environments/dev
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Terraform Init
        run: terraform init
      
      - name: Terraform Plan
        run: |
          terraform plan \
            -var="public_key=${{ secrets.SSH_PUBLIC_KEY }}" \
            -var="db_password=${{ secrets.DB_PASSWORD }}" \
            -var="use_rds=true" \
            -out=tfplan
      
      - name: Upload Terraform Plan
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan
          path: terraform/environments/dev/tfplan

  # ì¸í”„ë¼ ë°°í¬
  deploy-infrastructure:
    needs: [detect-changes, terraform-plan]
    if: |
      (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop' || github.ref == 'refs/heads/feat/infra') ||
      (github.event_name == 'pull_request_review' && github.event.review.state == 'approved' && github.event.pull_request.base.ref == 'develop')
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: terraform/environments/dev
    outputs:
      ec2-ip: ${{ steps.terraform-output.outputs.ec2_ip }}
      database-endpoint: ${{ steps.terraform-output.outputs.database_endpoint }}
      
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Download Terraform Plan
        uses: actions/download-artifact@v4
        with:
          name: terraform-plan
          path: terraform/environments/dev/
      
      - name: Terraform Init
        run: terraform init
      
      - name: Terraform Apply
        run: |
          terraform apply \
            -var="public_key=${{ secrets.SSH_PUBLIC_KEY }}" \
            -var="db_password=${{ secrets.DB_PASSWORD }}" \
            -var="use_rds=true" \
            -auto-approve
      
      - name: Get Terraform Outputs
        id: terraform-output
        run: |
          echo "ec2_ip=$(terraform output -raw ec2_public_ip)" >> $GITHUB_OUTPUT
          
          # RDS ì—”ë“œí¬ì¸íŠ¸ ë‹¨ìˆœí•˜ê²Œ ì¶”ì¶œ
          if terraform output database_endpoint 2>/dev/null; then
            DB_ENDPOINT=$(terraform output -raw database_endpoint)
            if [ "$DB_ENDPOINT" != "null" ] && [ -n "$DB_ENDPOINT" ]; then
              echo "database_endpoint=$DB_ENDPOINT" >> $GITHUB_OUTPUT
              echo "âœ… RDS ì—”ë“œí¬ì¸íŠ¸: $DB_ENDPOINT"
            else
              echo "âŒ RDS ì—”ë“œí¬ì¸íŠ¸ê°€ nullì´ê±°ë‚˜ ë¹„ì–´ìˆìŒ"
              echo "ğŸ” Terraform outputs ì „ì²´ í™•ì¸:"
              terraform output
              exit 1
            fi
          else
            echo "âŒ database_endpoint outputì„ ì°¾ì„ ìˆ˜ ì—†ìŒ"
            echo "ğŸ” ì‚¬ìš© ê°€ëŠ¥í•œ outputs:"
            terraform output
            exit 1
          fi
          
          echo "=== ì„±ê³µì ìœ¼ë¡œ ì¶”ì¶œëœ ì •ë³´ ==="
          echo "EC2 IP: $(terraform output -raw ec2_public_ip)"
          echo "DB ì—”ë“œí¬ì¸íŠ¸: $(terraform output -raw database_endpoint)"
          echo "DB ì´ë¦„: $(terraform output -raw database_name)"
          echo "DB ì‚¬ìš©ì: $(terraform output -raw database_username)"

  # ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬
  deploy-application:
    needs: [detect-changes, build-and-push, deploy-infrastructure]
    if: always() && (needs.build-and-push.result == 'success' || needs.deploy-infrastructure.result == 'success')
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Wait for EC2 to be ready
        run: sleep 60
      
      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ needs.deploy-infrastructure.outputs.ec2-ip }}
          username: ec2-user
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # =============================================================================
            # EC2 ì´ˆê¸° ì„¤ì •: ì‹œìŠ¤í…œ ìµœì í™” ë° ìŠ¤ì™‘ ì„¤ì •
            # =============================================================================
            
            # ìŠ¤ì™‘ íŒŒì¼ ìƒì„± (2GB) - t2.micro 1GB RAM ë³´ì™„
            # Spring Boot + Redis + Docker ë™ì‹œ ì‹¤í–‰ ì‹œ ë©”ëª¨ë¦¬ ë¶€ì¡± ë°©ì§€
            if [ ! -f /swapfile ]; then
              echo "ğŸ’¾ ìŠ¤ì™‘ íŒŒì¼ ìƒì„± ì¤‘..."
              sudo fallocate -l 2G /swapfile          # 2GB ìŠ¤ì™‘ íŒŒì¼ ìƒì„±
              sudo chmod 600 /swapfile                 # ë³´ì•ˆ ê¶Œí•œ ì„¤ì •
              sudo mkswap /swapfile                    # ìŠ¤ì™‘ ì˜ì—­ ì´ˆê¸°í™”
              sudo swapon /swapfile                    # ìŠ¤ì™‘ í™œì„±í™”
              
              # ì˜êµ¬ ìŠ¤ì™‘ ì„¤ì • (ì¬ë¶€íŒ… í›„ì—ë„ ìœ ì§€)
              echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab
              
              # ìŠ¤ì™‘ ì‚¬ìš© ìµœì í™” ì„¤ì •
              echo 'vm.swappiness=10' | sudo tee -a /etc/sysctl.conf      # ìŠ¤ì™‘ ì‚¬ìš© ë¹ˆë„ ë‚®ì¶¤ (RAM ìš°ì„ )
              echo 'vm.vfs_cache_pressure=50' | sudo tee -a /etc/sysctl.conf # íŒŒì¼ ì‹œìŠ¤í…œ ìºì‹œ ì••ë ¥ ì¡°ì ˆ
              
              # ì„¤ì • ì¦‰ì‹œ ì ìš©
              sudo sysctl vm.swappiness=10
              sudo sysctl vm.vfs_cache_pressure=50
              
              echo "âœ… ìŠ¤ì™‘ ì„¤ì • ì™„ë£Œ: $(free -h | grep Swap)"
            else
              echo "âœ… ìŠ¤ì™‘ ì´ë¯¸ ì„¤ì •ë¨: $(free -h | grep Swap)"
            fi
            
            # =============================================================================
            # Docker ë° Docker Compose ì„¤ì¹˜ í™•ì¸
            # =============================================================================
            
            # Docker ì„¤ì¹˜ í™•ì¸ ë° ì„¤ì¹˜
            if ! command -v docker &> /dev/null; then
              echo "ğŸ³ Docker ì„¤ì¹˜ ì¤‘..."
              sudo apt update
              sudo apt install -y docker.io docker-compose
              sudo systemctl start docker
              sudo systemctl enable docker
              sudo usermod -aG docker ubuntu
              echo "âœ… Docker ì„¤ì¹˜ ì™„ë£Œ"
            else
              echo "âœ… Docker ì´ë¯¸ ì„¤ì¹˜ë¨: $(docker --version)"
            fi
            
            # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì •ë¦¬
            sudo docker-compose down || true
            sudo docker system prune -f || true
            
            # í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ ìƒì„± ë° ê¸°ì¡´ íŒŒì¼ ì‚¬ìš©
            mkdir -p ~/unbox-app
            cd ~/unbox-app
            
            # ê¸°ì¡´ docker-compose-mvp.yml ë‹¤ìš´ë¡œë“œ
            curl -o docker-compose-mvp.yml https://raw.githubusercontent.com/team4-coding-gamja/UNBOX-BE/feat/infra/docker-compose-mvp.yml
            
            # í™˜ê²½ë³€ìˆ˜ë¥¼ docker-compose.ymlì— ì§ì ‘ ì„¤ì •
            # .env.mvp íŒŒì¼ ëŒ€ì‹  í™˜ê²½ë³€ìˆ˜ë¡œ ì§ì ‘ ì „ë‹¬
            sed -i '/env_file:/d' docker-compose-mvp.yml
            sed -i '/- \.env\.mvp/d' docker-compose-mvp.yml
            
            # í™˜ê²½ë³€ìˆ˜ë¥¼ docker-compose.ymlì— ì¶”ê°€
            sed -i '/SPRING_PROFILES_ACTIVE=mvp/a\      - SPRING_DATASOURCE_DRIVER_CLASS_NAME=org.postgresql.Driver' docker-compose-mvp.yml
            sed -i '/SPRING_DATASOURCE_DRIVER_CLASS_NAME=org.postgresql.Driver/a\      - SPRING_DATASOURCE_URL=jdbc:postgresql://${{ needs.deploy-infrastructure.outputs.database-endpoint }}/unboxdb' docker-compose-mvp.yml
            sed -i '/SPRING_DATASOURCE_URL=/a\      - SPRING_DATASOURCE_USERNAME=unboxadmin' docker-compose-mvp.yml
            sed -i '/SPRING_DATASOURCE_USERNAME=unboxadmin/a\      - SPRING_DATASOURCE_PASSWORD=${{ secrets.DB_PASSWORD }}' docker-compose-mvp.yml
            sed -i '/SPRING_DATASOURCE_PASSWORD=/a\      - SPRING_DATA_REDIS_HOST=redis' docker-compose-mvp.yml
            sed -i '/SPRING_DATA_REDIS_HOST=redis/a\      - SPRING_DATA_REDIS_PORT=6379' docker-compose-mvp.yml
            sed -i '/SPRING_DATA_REDIS_PORT=6379/a\      - SPRING_JWT_SECRET=${{ secrets.JWT_SECRET }}' docker-compose-mvp.yml
            
            # docker-compose-mvp.ymlì—ì„œ ì´ë¯¸ì§€ ë³€ê²½ ë° JVM ì˜µì…˜ ì¶”ê°€
            sed -i 's|build: .|image: ${{ env.DOCKER_IMAGE }}:latest|g' docker-compose-mvp.yml
            sed -i '/SPRING_PROFILES_ACTIVE=mvp/a\      - JAVA_OPTS=-Xms128m -Xmx512m -XX:+UseG1GC' docker-compose-mvp.yml
            
            # Docker Hubì—ì„œ ìµœì‹  ì´ë¯¸ì§€ Pull
            sudo docker pull ${{ env.DOCKER_IMAGE }}:latest
            
            # ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘
            sudo docker-compose -f docker-compose-mvp.yml up -d
            
            # í—¬ìŠ¤ì²´í¬ ëŒ€ê¸°
            echo "Waiting for application to start..."
            
            # Spring Boot ë¡œê·¸ ë¨¼ì € í™•ì¸
            echo "ğŸ“‹ === Spring Boot ì‹œì‘ ë¡œê·¸ í™•ì¸ ==="
            sudo docker logs unbox-mvp-app --tail=20
            echo ""
            
            # ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
            echo "ğŸ³ === ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸ ==="
            sudo docker ps
            echo ""
            
            # í™˜ê²½ë³€ìˆ˜ í™•ì¸
            echo "âš™ï¸ === í™˜ê²½ë³€ìˆ˜ í™•ì¸ ==="
            sudo docker exec unbox-mvp-app env | grep -E "JAVA_OPTS|SPRING_" || echo "í™˜ê²½ë³€ìˆ˜ í™•ì¸ ì‹¤íŒ¨"
            echo ""
            
            for i in {1..30}; do  # 5ë¶„ ëŒ€ê¸° (30 Ã— 10ì´ˆ)
              # í—¬ìŠ¤ì²´í¬ ì‘ë‹µ í™•ì¸ (ë” ê´€ëŒ€í•œ ì¡°ê±´)
              HEALTH_RESPONSE=$(curl -s http://localhost:8080/actuator/health || echo "")
              echo "ğŸ” Health ì‘ë‹µ: $HEALTH_RESPONSE"
              
              if echo "$HEALTH_RESPONSE" | grep -q '"status":"UP"'; then
                echo "âœ… Application is healthy!"
                break
              elif echo "$HEALTH_RESPONSE" | grep -q "status"; then
                echo "âš ï¸ Application responding but not UP yet..."
              elif curl -s http://localhost:8080/swagger-ui/index.html > /dev/null; then
                echo "âœ… Swagger UI accessible - assuming healthy!"
                break
              fi
                echo "âœ… Application is healthy!"
                
                # ì¶”ê°€ ëŒ€ê¸° ì‹œê°„ (Swagger ì´ˆê¸°í™” ì™„ë£Œ ëŒ€ê¸°)
                echo "â³ Swagger ì´ˆê¸°í™” ëŒ€ê¸° ì¤‘... (10ì´ˆ)"
                sleep 10
                
                # ì—¬ëŸ¬ Swagger ê²½ë¡œ í…ŒìŠ¤íŠ¸
                echo "ğŸ“š === ë‹¤ì–‘í•œ Swagger ê²½ë¡œ í…ŒìŠ¤íŠ¸ ==="
                
                # 1. ê¸°ë³¸ ê²½ë¡œ
                SWAGGER_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/swagger-ui/index.html)
                echo "ğŸ” /swagger-ui/index.html: $SWAGGER_STATUS"
                
                # 2. ëŒ€ì²´ ê²½ë¡œë“¤
                SWAGGER_STATUS2=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/swagger-ui.html)
                echo "ğŸ” /swagger-ui.html: $SWAGGER_STATUS2"
                
                SWAGGER_STATUS3=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/swagger-ui/)
                echo "ğŸ” /swagger-ui/: $SWAGGER_STATUS3"
                
                # ì„±ê³µí•œ ê²½ë¡œ í™•ì¸
                if [ "$SWAGGER_STATUS" = "200" ]; then
                  echo "âœ… Swagger UI ì ‘ê·¼ ê°€ëŠ¥! (/swagger-ui/index.html)"
                  WORKING_SWAGGER_PATH="/swagger-ui/index.html"
                elif [ "$SWAGGER_STATUS2" = "200" ]; then
                  echo "âœ… Swagger UI ì ‘ê·¼ ê°€ëŠ¥! (/swagger-ui.html)"
                  WORKING_SWAGGER_PATH="/swagger-ui.html"
                elif [ "$SWAGGER_STATUS3" = "200" ]; then
                  echo "âœ… Swagger UI ì ‘ê·¼ ê°€ëŠ¥! (/swagger-ui/)"
                  WORKING_SWAGGER_PATH="/swagger-ui/"
                else
                  echo "âŒ ëª¨ë“  Swagger ê²½ë¡œ ì ‘ê·¼ ì‹¤íŒ¨"
                  echo "ğŸ” ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œê·¸ í™•ì¸:"
                  sudo docker logs unbox-mvp-app --tail=20
                fi
                
                # ë„¤íŠ¸ì›Œí¬ ì—°ê²° í…ŒìŠ¤íŠ¸
                echo "ğŸŒ === ë„¤íŠ¸ì›Œí¬ ì—°ê²° í…ŒìŠ¤íŠ¸ ==="
                echo "ğŸ” 8080 í¬íŠ¸ ë¦¬ìŠ¤ë‹ í™•ì¸:"
                sudo netstat -tlnp | grep :8080 || echo "8080 í¬íŠ¸ê°€ ë¦¬ìŠ¤ë‹ë˜ì§€ ì•ŠìŒ"
                
                echo "ğŸ” Docker ì»¨í…Œì´ë„ˆ í¬íŠ¸ ë§¤í•‘:"
                sudo docker port unbox-mvp-app || echo "í¬íŠ¸ ë§¤í•‘ ì •ë³´ ì—†ìŒ"
                
                echo "ğŸ” ë°©í™”ë²½ ìƒíƒœ:"
                sudo ufw status || echo "ufw ë¹„í™œì„±í™”ë¨"
                
                break
              fi
              
              # 10ë²ˆì§¸ë§ˆë‹¤ ë¡œê·¸ í™•ì¸ (ë” ìì£¼)
              if [ $((i % 10)) -eq 0 ]; then
                echo "ğŸ“‹ === ì§„í–‰ ìƒí™© ë¡œê·¸ (ì‹œë„ $i/30) ==="
                sudo docker logs unbox-mvp-app --tail=10
                echo ""
              fi
              
              echo "Waiting... ($i/30)"
              sleep 10
            done
            
            # ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
            sudo docker ps
            sudo docker-compose logs --tail=50
            
            # =============================================================================
            # ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ì²´í¬
            # =============================================================================
            
            echo "ğŸ“Š === ì‹œìŠ¤í…œ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ==="
            free -h
            echo ""
            
            echo "ğŸ³ === Docker ì»¨í…Œì´ë„ˆ ë¦¬ì†ŒìŠ¤ ì‚¬ìš©ëŸ‰ ==="
            sudo docker stats --no-stream
            echo ""
            
            echo "â˜• === JVM ë©”ëª¨ë¦¬ ì •ë³´ (5ì´ˆ í›„ ì²´í¬) ==="
            sleep 5
            curl -s http://localhost:8080/actuator/metrics/jvm.memory.used 2>/dev/null || echo "JVM ë©”íŠ¸ë¦­ ì•„ì§ ì¤€ë¹„ë˜ì§€ ì•ŠìŒ"
            curl -s http://localhost:8080/actuator/metrics/jvm.memory.max 2>/dev/null || echo "JVM ë©”íŠ¸ë¦­ ì•„ì§ ì¤€ë¹„ë˜ì§€ ì•ŠìŒ"
            echo ""
            
            echo "ğŸ’¾ === ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰ ==="
            df -h
            echo ""
            
            echo "âš¡ === ì‹œìŠ¤í…œ ë¡œë“œ ==="
            uptime

  # ë°°í¬ ì™„ë£Œ ì•Œë¦¼
  notify-completion:
    needs: [deploy-infrastructure, deploy-application]
    if: always()
    runs-on: ubuntu-latest
    
    steps:
      - name: Deployment Status
        run: |
          echo "ğŸš€ UNBOX ë°°í¬ ì™„ë£Œ!"
          echo "ğŸ“± ì• í”Œë¦¬ì¼€ì´ì…˜: http://${{ needs.deploy-infrastructure.outputs.ec2-ip }}:8080"
          echo "ğŸ“š Swagger UI: http://${{ needs.deploy-infrastructure.outputs.ec2-ip }}:8080/swagger-ui/index.html"
          echo "ï¿½  API Docs: http://${{ needs.deploy-infrastructure.outputs.ec2-ip }}:8080/v3/api-docs"
          echo "ï¿½ Health Cmheck: http://${{ needs.deploy-infrastructure.outputs.ec2-ip }}:8080/actuator/health"
          echo "ğŸ³ Docker Image: ${{ env.DOCKER_IMAGE }}:latest"

  # ì¸í”„ë¼ ì •ë¦¬ (í…ŒìŠ¤íŠ¸ìš©)
  cleanup-infrastructure:
    needs: [deploy-infrastructure, deploy-application]
    if: github.event.inputs.destroy_infrastructure == 'true'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: terraform/environments/dev
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Terraform Init
        run: terraform init
      
      - name: Terraform Destroy
        run: |
          terraform destroy \
            -var="public_key=${{ secrets.SSH_PUBLIC_KEY }}" \
            -var="db_password=${{ secrets.DB_PASSWORD }}" \
            -var="use_rds=true" \
            -auto-approve