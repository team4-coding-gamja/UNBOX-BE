name: Product Service - Dev CD

on:
  workflow_run:
    workflows: ["Product Service - Dev CI"]
    types:
      - completed
    branches:
      - develop

  workflow_dispatch:
    inputs:
      image-tag:
        description: 'Image tag to deploy (Git SHA)'
        required: true

env:
  AWS_REGION: ap-northeast-2
  ECS_SERVICE: unbox-dev-product
  ECS_CLUSTER: unbox-dev-cluster
  TASK_DEFINITION_FAMILY: unbox-dev-product
  SERVICE_NAME: product

jobs:
  deploy:
    name: Deploy to Dev
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.DEV_IAM_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Get image tag
        id: image-tag
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "tag=${{ github.event.inputs.image-tag }}" >> $GITHUB_OUTPUT
          else
            # workflow_run ì´ë²¤íŠ¸ì—ì„œëŠ” íŠ¸ë¦¬ê±°í•œ ì›Œí¬í”Œë¡œìš°ì˜ SHA ì‚¬ìš©
            echo "tag=dev-${{ github.event.workflow_run.head_sha }}" >> $GITHUB_OUTPUT
          fi

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Get current task definition
        id: get-task-def
        run: |
          # í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ Task Definition ê°€ì ¸ì˜¤ê¸°
          TASK_DEF_ARN=$(aws ecs describe-services \
            --cluster ${{ env.ECS_CLUSTER }} \
            --services ${{ env.ECS_SERVICE }} \
            --query 'services[0].taskDefinition' \
            --output text)
          
          echo "current-task-def=$TASK_DEF_ARN" >> $GITHUB_OUTPUT
          
          # Task Definition JSON ë‹¤ìš´ë¡œë“œ
          aws ecs describe-task-definition \
            --task-definition $TASK_DEF_ARN \
            --query 'taskDefinition' > task-def.json

      - name: Update task definition with new image
        id: update-task-def
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ steps.image-tag.outputs.tag }}
        run: |
          # ìƒˆ ì´ë¯¸ì§€ URI ìƒì„±
          NEW_IMAGE="${ECR_REGISTRY}/unbox-dev-product-repo:${IMAGE_TAG}"
          
          # Task Definitionì—ì„œ ë¶ˆí•„ìš”í•œ í•„ë“œ ì œê±° ë° ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸
          cat task-def.json | jq --arg IMAGE "$NEW_IMAGE" '
            del(.taskDefinitionArn, .revision, .status, .requiresAttributes, .compatibilities, .registeredAt, .registeredBy, .deregisteredAt) |
            .containerDefinitions[0].image = $IMAGE
          ' > task-def-updated.json
          
          echo "Updated task definition:"
          cat task-def-updated.json

      - name: Register new task definition
        id: register-task-def
        run: |
          TASK_DEF_ARN=$(aws ecs register-task-definition \
            --cli-input-json file://task-def-updated.json \
            --query 'taskDefinition.taskDefinitionArn' \
            --output text)
          echo "task-def-arn=$TASK_DEF_ARN" >> $GITHUB_OUTPUT
          echo "Registered new task definition: $TASK_DEF_ARN"

      - name: Update ECS service
        run: |
          aws ecs update-service \
            --cluster ${{ env.ECS_CLUSTER }} \
            --service ${{ env.ECS_SERVICE }} \
            --task-definition ${{ steps.register-task-def.outputs.task-def-arn }} \
            --force-new-deployment

      - name: Check deployment status
        id: check-deployment
        run: |
          echo "ğŸ” ECS ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸ ì¤‘..."
          
          # í˜„ì¬ ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
          aws ecs describe-services \
            --cluster ${{ env.ECS_CLUSTER }} \
            --services ${{ env.ECS_SERVICE }} \
            --query 'services[0].{status:status,runningCount:runningCount,desiredCount:desiredCount,deployments:deployments}' \
            --output json | tee service-status.json
          
          # ìµœê·¼ íƒœìŠ¤í¬ ì´ë²¤íŠ¸ í™•ì¸
          echo ""
          echo "ğŸ“‹ ìµœê·¼ ì„œë¹„ìŠ¤ ì´ë²¤íŠ¸:"
          aws ecs describe-services \
            --cluster ${{ env.ECS_CLUSTER }} \
            --services ${{ env.ECS_SERVICE }} \
            --query 'services[0].events[:5]' \
            --output table
          
          # ì‹¤í–‰ ì¤‘ì¸ íƒœìŠ¤í¬ í™•ì¸
          echo ""
          echo "ğŸƒ ì‹¤í–‰ ì¤‘ì¸ íƒœìŠ¤í¬ ëª©ë¡:"
          TASK_ARNS=$(aws ecs list-tasks \
            --cluster ${{ env.ECS_CLUSTER }} \
            --service-name ${{ env.ECS_SERVICE }} \
            --query 'taskArns' \
            --output text)
          
          if [ -n "$TASK_ARNS" ]; then
            aws ecs describe-tasks \
              --cluster ${{ env.ECS_CLUSTER }} \
              --tasks $TASK_ARNS \
              --query 'tasks[*].{taskArn:taskArn,lastStatus:lastStatus,healthStatus:healthStatus,containers:containers[*].{name:name,status:lastStatus,exitCode:exitCode,reason:reason}}' \
              --output json | tee tasks-status.json
          else
            echo "âš ï¸ ì‹¤í–‰ ì¤‘ì¸ íƒœìŠ¤í¬ê°€ ì—†ìŠµë‹ˆë‹¤."
          fi

      - name: Wait for service stability
        run: |
          echo "â³ ECS ì„œë¹„ìŠ¤ ì•ˆì •í™” ëŒ€ê¸° ì¤‘ (ìµœëŒ€ 15ë¶„)..."
          
          # 15ë¶„ íƒ€ì„ì•„ì›ƒ ì„¤ì •
          aws ecs wait services-stable \
            --cluster ${{ env.ECS_CLUSTER }} \
            --services ${{ env.ECS_SERVICE }} \
            --cli-read-timeout 900 \
            --cli-connect-timeout 900 || {
            
            echo "âŒ ì„œë¹„ìŠ¤ ì•ˆì •í™” ì‹¤íŒ¨!"
            echo ""
            echo "ğŸ” ì‹¤íŒ¨ ì›ì¸ ë¶„ì„:"
            
            # ì‹¤íŒ¨í•œ íƒœìŠ¤í¬ ë¡œê·¸ í™•ì¸
            STOPPED_TASKS=$(aws ecs list-tasks \
              --cluster ${{ env.ECS_CLUSTER }} \
              --service-name ${{ env.ECS_SERVICE }} \
              --desired-status STOPPED \
              --query 'taskArns[:3]' \
              --output text)
            
            if [ -n "$STOPPED_TASKS" ]; then
              echo "âš ï¸ ì¤‘ì§€ëœ íƒœìŠ¤í¬ ì •ë³´:"
              aws ecs describe-tasks \
                --cluster ${{ env.ECS_CLUSTER }} \
                --tasks $STOPPED_TASKS \
                --query 'tasks[*].{taskArn:taskArn,stoppedReason:stoppedReason,containers:containers[*].{name:name,exitCode:exitCode,reason:reason}}' \
                --output json
            fi
            
            # ì„œë¹„ìŠ¤ ì´ë²¤íŠ¸ ì¬í™•ì¸
            echo ""
            echo "ğŸ“‹ ìµœì‹  ì„œë¹„ìŠ¤ ì´ë²¤íŠ¸:"
            aws ecs describe-services \
              --cluster ${{ env.ECS_CLUSTER }} \
              --services ${{ env.ECS_SERVICE }} \
              --query 'services[0].events[:10]' \
              --output table
            
            exit 1
          }
          
          echo "âœ… ì„œë¹„ìŠ¤ê°€ ì•ˆì •í™”ë˜ì—ˆìŠµë‹ˆë‹¤!"

      - name: Notify Discord - Deployment Success
        run: |
          curl -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{
              "embeds": [{
                "title": "âœ… Dev ë°°í¬ ì„±ê³µ - Product ì„œë¹„ìŠ¤",
                "description": "**í™˜ê²½:** Dev\n**ì„œë¹„ìŠ¤:** product-service\n**ì»¤ë°‹:** `${{ steps.image-tag.outputs.tag }}`\n**Task Definition:** `${{ steps.register-task-def.outputs.task-def-arn }}`",
                "color": 3066993,
                "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"
              }]
            }'

      - name: Collect failure diagnostics
        if: failure()
        id: diagnostics
        run: |
          echo "ğŸ” ì‹¤íŒ¨ ì§„ë‹¨ ì •ë³´ ìˆ˜ì§‘ ì¤‘..."
          
          # ì„œë¹„ìŠ¤ ìƒíƒœ
          SERVICE_STATUS=$(aws ecs describe-services \
            --cluster ${{ env.ECS_CLUSTER }} \
            --services ${{ env.ECS_SERVICE }} \
            --query 'services[0].events[0].message' \
            --output text 2>/dev/null || echo "ìƒíƒœ í™•ì¸ ë¶ˆê°€")
          
          # ì¤‘ì§€ëœ íƒœìŠ¤í¬ ì •ë³´
          STOPPED_REASON=$(aws ecs list-tasks \
            --cluster ${{ env.ECS_CLUSTER }} \
            --service-name ${{ env.ECS_SERVICE }} \
            --desired-status STOPPED \
            --query 'taskArns[0]' \
            --output text 2>/dev/null)
          
          if [ -n "$STOPPED_REASON" ] && [ "$STOPPED_REASON" != "None" ]; then
            TASK_INFO=$(aws ecs describe-tasks \
              --cluster ${{ env.ECS_CLUSTER }} \
              --tasks $STOPPED_REASON \
              --query 'tasks[0].{reason:stoppedReason,container:containers[0].reason}' \
              --output json 2>/dev/null || echo '{}')
            
            STOP_REASON=$(echo "$TASK_INFO" | jq -r '.reason // "ì•Œ ìˆ˜ ì—†ìŒ"')
            CONTAINER_REASON=$(echo "$TASK_INFO" | jq -r '.container // "ì•Œ ìˆ˜ ì—†ìŒ"')
          else
            STOP_REASON="íƒœìŠ¤í¬ ì •ë³´ ì—†ìŒ"
            CONTAINER_REASON="N/A"
          fi
          
          # ê²°ê³¼ë¥¼ íŒŒì¼ë¡œ ì €ì¥ (Discord ë©”ì‹œì§€ìš©)
          cat > failure-info.txt <<EOF
          **ì„œë¹„ìŠ¤ ìƒíƒœ:** ${SERVICE_STATUS}
          **ì¤‘ì§€ ì´ìœ :** ${STOP_REASON}
          **ì»¨í…Œì´ë„ˆ ìƒíƒœ:** ${CONTAINER_REASON}
          EOF
          
          echo "service_status=${SERVICE_STATUS}" >> $GITHUB_OUTPUT
          echo "stop_reason=${STOP_REASON}" >> $GITHUB_OUTPUT

      - name: Notify Discord - Deployment Failed
        if: failure()
        run: |
          # ì§„ë‹¨ ì •ë³´ ì½ê¸°
          if [ -f failure-info.txt ]; then
            FAILURE_INFO=$(cat failure-info.txt)
          else
            FAILURE_INFO="**ì‹¤íŒ¨ ì›ì¸:** ë°°í¬ ë˜ëŠ” í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨"
          fi
          
          curl -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{
              "embeds": [{
                "title": "âŒ Dev ë°°í¬ ì‹¤íŒ¨ - Product ì„œë¹„ìŠ¤",
                "description": "**í™˜ê²½:** Dev\n**ì„œë¹„ìŠ¤:** product-service\n**ì»¤ë°‹:** `${{ steps.image-tag.outputs.tag }}`\n\n'"${FAILURE_INFO}"'\n\n**ì¡°ì¹˜ ë°©ë²•:**\n1. CloudWatch Logsì—ì„œ ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œê·¸ í™•ì¸\n2. ECS ì½˜ì†”ì—ì„œ íƒœìŠ¤í¬ ìƒíƒœ í™•ì¸\n3. ALB í—¬ìŠ¤ì²´í¬ ì„¤ì • ê²€í† ",
                "color": 15158332,
                "fields": [
                  {
                    "name": "ğŸ”— CloudWatch Logs",
                    "value": "[ë¡œê·¸ í™•ì¸](https://console.aws.amazon.com/cloudwatch/home?region=ap-northeast-2#logsV2:log-groups/log-group/$252Fecs$252Funbox-dev-product)",
                    "inline": false
                  },
                  {
                    "name": "ğŸ”— ECS ì„œë¹„ìŠ¤",
                    "value": "[ì„œë¹„ìŠ¤ í™•ì¸](https://console.aws.amazon.com/ecs/v2/clusters/unbox-dev-cluster/services/unbox-dev-product)",
                    "inline": false
                  }
                ],
                "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"
              }]
            }'
