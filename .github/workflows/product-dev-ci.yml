name: Product Service - Dev CI

on:
  push:
    branches:
      - develop
    paths:
      - 'unbox_product/**'
      - 'unbox_common/**'
      - '.github/workflows/product-dev-ci.yml'

  workflow_dispatch:

env:
  AWS_REGION: ap-northeast-2
  ECR_REPOSITORY: unbox-product-service
  SERVICE_NAME: product-service
  SERVICE_PATH: unbox_product

jobs:
  # test:
  #   name: Run Tests
  #   runs-on: ubuntu-latest
  #   
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4
  #
  #     - name: Set up JDK 17
  #       uses: actions/setup-java@v4
  #       with:
  #         java-version: '17'
  #         distribution: 'temurin'
  #         cache: gradle
  #
  #     - name: Grant execute permission for gradlew
  #       run: chmod +x ./gradlew
  #       working-directory: ${{ env.SERVICE_PATH }}
  #
  #     - name: Run tests
  #       run: ./gradlew test
  #       working-directory: ${{ env.SERVICE_PATH }}
  #
  #     - name: Notify Discord - Test Failed
  #       if: failure()
  #       run: |
  #         curl -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
  #           -H "Content-Type: application/json" \
  #           -d '{
  #             "embeds": [{
  #               "title": "âŒ Dev CI ì‹¤íŒ¨ - Product ì„œë¹„ìŠ¤",
  #               "description": "**í™˜ê²½:** Dev\n**ì„œë¹„ìŠ¤:** product-service\n**ë¸Œëœì¹˜:** develop\n**ì»¤ë°‹:** `${{ github.sha }}`\n**ì‹¤íŒ¨ ì›ì¸:** í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨",
  #               "color": 15158332,
  #               "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"
  #             }]
  #           }'

  build:
    name: Build and Push Image
    runs-on: ubuntu-latest
    # needs: test
    permissions:
      id-token: write
      contents: read
    
    outputs:
      image-tag: ${{ steps.image-tag.outputs.tag }}
      image-uri: ${{ steps.build-image.outputs.image }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Gradle ìºì‹œ ì„¤ì •
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew

      - name: Download dependencies
        run: ./gradlew dependencies --no-daemon || true

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.DEV_IAM_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-ProductCI
          audience: sts.amazonaws.com

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set image tag
        id: image-tag
        run: echo "tag=dev-${{ github.sha }}" >> $GITHUB_OUTPUT

      # Docker Buildx ì„¤ì • (ë ˆì´ì–´ ìºì‹œìš©)
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # ë¹Œë“œ ì‹œì‘ ì‹œê°„ ê¸°ë¡
      - name: Record build start time
        id: build-start
        run: echo "time=$(date +%s)" >> $GITHUB_OUTPUT

      # Docker ë¹Œë“œ ë° í‘¸ì‹œ (ECR ë ˆì´ì–´ ìºì‹œ í™œìš©)
      - name: Build and push Docker image
        id: build-image
        uses: docker/build-push-action@v5
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ steps.image-tag.outputs.tag }}
        with:
          context: .
          file: ${{ env.SERVICE_PATH }}/Dockerfile
          push: true
          tags: |
            ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }}
            ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:latest
          # ECRì„ ìºì‹œ ì €ì¥ì†Œë¡œ ì‚¬ìš© (ë¹Œë“œ ì†ë„ í–¥ìƒ)
          cache-from: type=registry,ref=${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:buildcache
          cache-to: type=registry,ref=${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:buildcache,mode=max
          # ë¹Œë“œ ì¸ì (í•„ìš”ì‹œ ì¶”ê°€)
          build-args: |
            BUILDKIT_INLINE_CACHE=1

      # ë¹Œë“œ ì¢…ë£Œ ì‹œê°„ ê¸°ë¡ ë° ì†Œìš” ì‹œê°„ ê³„ì‚°
      - name: Calculate build time
        id: build-time
        run: |
          END_TIME=$(date +%s)
          BUILD_TIME=$((END_TIME - ${{ steps.build-start.outputs.time }}))
          BUILD_TIME_MIN=$((BUILD_TIME / 60))
          BUILD_TIME_SEC=$((BUILD_TIME % 60))
          echo "seconds=$BUILD_TIME" >> $GITHUB_OUTPUT
          echo "formatted=${BUILD_TIME_MIN}ë¶„ ${BUILD_TIME_SEC}ì´ˆ" >> $GITHUB_OUTPUT
          echo "ğŸ“Š ë¹Œë“œ ì†Œìš” ì‹œê°„: ${BUILD_TIME_MIN}ë¶„ ${BUILD_TIME_SEC}ì´ˆ"

      # ì´ë¯¸ì§€ í¬ê¸° í™•ì¸
      - name: Check image size
        id: image-size
        run: |
          IMAGE_ID=$(docker images -q ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ steps.image-tag.outputs.tag }})
          if [ -n "$IMAGE_ID" ]; then
            SIZE=$(docker images $IMAGE_ID --format "{{.Size}}")
            echo "size=$SIZE" >> $GITHUB_OUTPUT
            echo "ğŸ“¦ ì´ë¯¸ì§€ í¬ê¸°: $SIZE"
          else
            echo "size=N/A" >> $GITHUB_OUTPUT
          fi

      # ìºì‹œ íš¨ìœ¨ ë¶„ì„ (ë¹Œë“œ ë¡œê·¸ì—ì„œ CACHED ë ˆì´ì–´ ìˆ˜ í™•ì¸)
      - name: Analyze cache efficiency
        id: cache-analysis
        run: |
          # Docker Buildx ë¡œê·¸ëŠ” ìë™ìœ¼ë¡œ ì¶œë ¥ë˜ë¯€ë¡œ ì´ì „ ë‹¨ê³„ì˜ ë¡œê·¸ë¥¼ ë¶„ì„
          echo "cache_info=ìºì‹œ ë¶„ì„ ì™„ë£Œ" >> $GITHUB_OUTPUT
          echo "ğŸ’¾ Docker ë ˆì´ì–´ ìºì‹œ í™œìš©ë¨"

      # GitHub Actions Job Summaryì— ë¹Œë“œ ë©”íŠ¸ë¦­ ì¶”ê°€
      - name: Generate build summary
        if: always()
        run: |
          cat >> $GITHUB_STEP_SUMMARY <<EOF
          ## ğŸš€ Product Service ë¹Œë“œ ê²°ê³¼
          
          ### ğŸ“Š ë¹Œë“œ ë©”íŠ¸ë¦­
          
          | í•­ëª© | ê°’ |
          |------|-----|
          | â±ï¸ ë¹Œë“œ ì‹œê°„ | **${{ steps.build-time.outputs.formatted }}** (${{ steps.build-time.outputs.seconds }}ì´ˆ) |
          | ğŸ“¦ ì´ë¯¸ì§€ í¬ê¸° | ${{ steps.image-size.outputs.size }} |
          | ğŸ·ï¸ ì´ë¯¸ì§€ íƒœê·¸ | \`${{ steps.image-tag.outputs.tag }}\` |
          | ğŸ’¾ ìºì‹œ ì „ëµ | ECR Registry Cache |
          | ğŸ”§ ë¹Œë“œ ë„êµ¬ | Docker Buildx + Gradle 8.5 |
          
          ### ğŸ“ˆ ìºì‹œ ìµœì í™” íš¨ê³¼
          
          - âœ… ECR ë ˆì´ì–´ ìºì‹œ í™œì„±í™”
          - âœ… Gradle ì˜ì¡´ì„± ìºì‹œ í™œì„±í™”
          - ğŸ’¡ ì˜ˆìƒ íš¨ìœ¨: ì½”ë“œ ë³€ê²½ ì‹œ 40-50% ë¹Œë“œ ì‹œê°„ ë‹¨ì¶•
          
          ### ğŸ”— ì´ë¯¸ì§€ ì •ë³´
          
          \`\`\`
          ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ steps.image-tag.outputs.tag }}
          \`\`\`
          
          ### ğŸ“ ì»¤ë°‹ ì •ë³´
          
          - **SHA**: \`${{ github.sha }}\`
          - **ë¸Œëœì¹˜**: \`${{ github.ref_name }}\`
          - **ì‘ì„±ì**: ${{ github.actor }}
          - **ì‹œê°„**: $(date -u +%Y-%m-%d\ %H:%M:%S\ UTC)
          
          ---
          
          > ğŸ’¡ **Tip**: ë¹Œë“œ ì‹œê°„ì´ ì˜ˆìƒë³´ë‹¤ ê¸¸ë‹¤ë©´ ìºì‹œê°€ ë¬´íš¨í™”ë˜ì—ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. build.gradleì´ë‚˜ ì˜ì¡´ì„±ì´ ë³€ê²½ë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.
          EOF

      - name: Set image output
        run: echo "image=${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ steps.image-tag.outputs.tag }}" >> $GITHUB_OUTPUT

      - name: Notify Discord - CI Success
        run: |
          curl -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{
              "embeds": [{
                "title": "âœ… Dev CI ì„±ê³µ - Product ì„œë¹„ìŠ¤",
                "description": "**í™˜ê²½:** Dev\n**ì„œë¹„ìŠ¤:** product-service\n**ë¸Œëœì¹˜:** develop\n**ì»¤ë°‹:** `${{ github.sha }}`\n**ì´ë¯¸ì§€:** `${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ steps.image-tag.outputs.tag }}`\n\n**ğŸ“Š ë¹Œë“œ ë©”íŠ¸ë¦­:**\nâ±ï¸ ë¹Œë“œ ì‹œê°„: ${{ steps.build-time.outputs.formatted }}\nğŸ“¦ ì´ë¯¸ì§€ í¬ê¸°: ${{ steps.image-size.outputs.size }}\nğŸ’¾ ìºì‹œ: ECR ë ˆì´ì–´ ìºì‹œ í™œìš©",
                "color": 3066993,
                "fields": [
                  {
                    "name": "ë¹Œë“œ ì‹œê°„",
                    "value": "${{ steps.build-time.outputs.formatted }}",
                    "inline": true
                  },
                  {
                    "name": "ì´ë¯¸ì§€ í¬ê¸°",
                    "value": "${{ steps.image-size.outputs.size }}",
                    "inline": true
                  }
                ],
                "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"
              }]
            }'

      - name: Notify Discord - CI Failed
        if: failure()
        run: |
          curl -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{
              "embeds": [{
                "title": "âŒ Dev CI ì‹¤íŒ¨ - Product ì„œë¹„ìŠ¤",
                "description": "**í™˜ê²½:** Dev\n**ì„œë¹„ìŠ¤:** product-service\n**ë¸Œëœì¹˜:** develop\n**ì»¤ë°‹:** `${{ github.sha }}`\n**ì‹¤íŒ¨ ì›ì¸:** ë¹Œë“œ ë˜ëŠ” í‘¸ì‹œ ì‹¤íŒ¨",
                "color": 15158332,
                "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"
              }]
            }'
