name: User Service - Dev CD

on:
  workflow_run:
    workflows: ["User Service - Dev CI"]
    types:
      - completed
    branches:
      - develop

  workflow_dispatch:
    inputs:
      image-tag:
        description: 'Image tag to deploy (Git SHA)'
        required: true

env:
  AWS_REGION: ap-northeast-2
  ECS_SERVICE: unbox-dev-user-service
  ECS_CLUSTER: unbox-dev-cluster
  TASK_DEFINITION_FAMILY: unbox-dev-user
  SERVICE_NAME: user

jobs:
  deploy:
    name: Deploy to Dev
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.DEV_IAM_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Get image tag
        id: image-tag
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "tag=${{ github.event.inputs.image-tag }}" >> $GITHUB_OUTPUT
          else
            echo "tag=dev-${{ github.sha }}" >> $GITHUB_OUTPUT
          fi

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Get AWS Account ID
        id: account-id
        run: |
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          echo "account_id=$ACCOUNT_ID" >> $GITHUB_OUTPUT

      - name: Get DB and Redis endpoints
        id: get-endpoints
        run: |
          # RDS 엔드포인트 가져오기
          DB_ENDPOINT=$(aws rds describe-db-instances \
            --db-instance-identifier unbox-dev-user-db \
            --query 'DBInstances[0].Endpoint.Address' \
            --output text)
          echo "db_endpoint=$DB_ENDPOINT" >> $GITHUB_OUTPUT
          
          # Redis 엔드포인트 가져오기
          REDIS_ENDPOINT=$(aws elasticache describe-cache-clusters \
            --cache-cluster-id unbox-dev-user-redis \
            --show-cache-node-info \
            --query 'CacheClusters[0].CacheNodes[0].Endpoint.Address' \
            --output text)
          echo "redis_endpoint=$REDIS_ENDPOINT" >> $GITHUB_OUTPUT

      - name: Get Secrets ARNs
        id: get-secrets
        run: |
          # DB 비밀번호 Secret ARN
          DB_SECRET_ARN=$(aws secretsmanager list-secrets \
            --filters Key=name,Values=unbox-dev-user-db-password \
            --query 'SecretList[0].ARN' \
            --output text)
          echo "db_secret_arn=$DB_SECRET_ARN" >> $GITHUB_OUTPUT
          
          # JWT Secret ARN
          JWT_SECRET_ARN=$(aws secretsmanager list-secrets \
            --filters Key=name,Values=unbox-dev-jwt-secret \
            --query 'SecretList[0].ARN' \
            --output text)
          echo "jwt_secret_arn=$JWT_SECRET_ARN" >> $GITHUB_OUTPUT

      - name: Render task definition
        id: render-task-def
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ steps.image-tag.outputs.tag }}
          ACCOUNT_ID: ${{ steps.account-id.outputs.account_id }}
          DB_ENDPOINT: ${{ steps.get-endpoints.outputs.db_endpoint }}
          REDIS_ENDPOINT: ${{ steps.get-endpoints.outputs.redis_endpoint }}
          DB_PASSWORD_SECRET_ARN: ${{ steps.get-secrets.outputs.db_secret_arn }}
          JWT_SECRET_ARN: ${{ steps.get-secrets.outputs.jwt_secret_arn }}
        run: |
          sed -e "s|<IMAGE_TAG>|$IMAGE_TAG|g" \
              -e "s|ACCOUNT_ID|$ACCOUNT_ID|g" \
              -e "s|DB_ENDPOINT|$DB_ENDPOINT|g" \
              -e "s|REDIS_ENDPOINT|$REDIS_ENDPOINT|g" \
              -e "s|DB_PASSWORD_SECRET_ARN|$DB_PASSWORD_SECRET_ARN|g" \
              -e "s|JWT_SECRET_ARN|$JWT_SECRET_ARN|g" \
            task-definitions/dev-user-service.json > task-def-rendered.json
          cat task-def-rendered.json

      - name: Register task definition
        id: register-task-def
        run: |
          TASK_DEF_ARN=$(aws ecs register-task-definition \
            --cli-input-json file://task-def-rendered.json \
            --query 'taskDefinition.taskDefinitionArn' \
            --output text)
          echo "task-def-arn=$TASK_DEF_ARN" >> $GITHUB_OUTPUT

      - name: Update ECS service
        run: |
          aws ecs update-service \
            --cluster ${{ env.ECS_CLUSTER }} \
            --service ${{ env.ECS_SERVICE }} \
            --task-definition ${{ steps.register-task-def.outputs.task-def-arn }} \
            --force-new-deployment

      - name: Wait for service stability
        run: |
          aws ecs wait services-stable \
            --cluster ${{ env.ECS_CLUSTER }} \
            --services ${{ env.ECS_SERVICE }}

      - name: Notify Discord - Deployment Success
        run: |
          curl -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{
              "embeds": [{
                "title": "✅ Dev 배포 성공 - User 서비스",
                "description": "**환경:** Dev\n**서비스:** user-service\n**커밋:** `${{ steps.image-tag.outputs.tag }}`\n**Task Definition:** `${{ steps.register-task-def.outputs.task-def-arn }}`",
                "color": 3066993,
                "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"
              }]
            }'

      - name: Notify Discord - Deployment Failed
        if: failure()
        run: |
          curl -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{
              "embeds": [{
                "title": "❌ Dev 배포 실패 - User 서비스",
                "description": "**환경:** Dev\n**서비스:** user-service\n**커밋:** `${{ steps.image-tag.outputs.tag }}`\n**실패 원인:** 배포 또는 헬스체크 실패",
                "color": 15158332,
                "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"
              }]
            }'
