name: User Service - Dev CI
# Test CI/CD pipeline - 2026-01-28 09:55

on:
  push:
    branches:
      - develop
    paths:
      - 'unbox_user/**'
      - 'unbox_common/**'
      - '.github/workflows/user-dev-ci.yml'

  workflow_dispatch:

env:
  AWS_REGION: ap-northeast-2
  ECR_REPOSITORY: unbox-dev-user-repo
  SERVICE_NAME: user-service
  SERVICE_PATH: unbox_user

jobs:
  # ============================================
  # Job 1: í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (í˜„ì¬ ë¹„í™œì„±í™”)
  # ëª©ì : ì½”ë“œ í’ˆì§ˆ ê²€ì¦ ë° ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
  # ë¹„í™œì„±í™” ì´ìœ : ë¹ ë¥¸ ë°°í¬ë¥¼ ìœ„í•´ ì„ì‹œë¡œ ìŠ¤í‚µ
  # ============================================
  # test:
  #   name: Run Tests
  #   runs-on: ubuntu-latest
  #   
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4
  #
  #     - name: Set up JDK 17
  #       uses: actions/setup-java@v4
  #       with:
  #         java-version: '17'
  #         distribution: 'temurin'
  #         cache: gradle
  #
  #     - name: Grant execute permission for gradlew
  #       run: chmod +x ./gradlew
  #       working-directory: ${{ env.SERVICE_PATH }}
  #
  #     - name: Run tests
  #       run: ./gradlew test
  #       working-directory: ${{ env.SERVICE_PATH }}
  #
  #     - name: Notify Discord - Test Failed
  #       if: failure()
  #       run: |
  #         curl -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
  #           -H "Content-Type: application/json" \
  #           -d '{
  #             "embeds": [{
  #               "title": "âŒ Dev CI ì‹¤íŒ¨ - User ì„œë¹„ìŠ¤",
  #               "description": "**í™˜ê²½:** Dev\n**ì„œë¹„ìŠ¤:** user-service\n**ë¸Œëœì¹˜:** develop\n**ì»¤ë°‹:** `${{ github.sha }}`\n**ì‹¤íŒ¨ ì›ì¸:** í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨",
  #               "color": 15158332,
  #               "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"
  #             }]
  #           }'

  # ============================================
  # Job 2: Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° ECR í‘¸ì‹œ
  # ëª©ì : ìµœì í™”ëœ Docker ì´ë¯¸ì§€ë¥¼ ë¹Œë“œí•˜ê³  ECRì— ì—…ë¡œë“œ
  # ì£¼ìš” ê¸°ëŠ¥:
  # - Gradle ì˜ì¡´ì„± ìºì‹±ìœ¼ë¡œ ë¹Œë“œ ì†ë„ í–¥ìƒ
  # - ECR ë ˆì´ì–´ ìºì‹œë¡œ Docker ë¹Œë“œ ìµœì í™”
  # - ì´ë¯¸ì§€ í¬ê¸° ë° ë¹Œë“œ ì‹œê°„ ë©”íŠ¸ë¦­ ìˆ˜ì§‘
  # - Discord ì•Œë¦¼ìœ¼ë¡œ íŒ€ ê³µìœ 
  # ============================================
  build:
    name: Build and Push Image
    runs-on: ubuntu-latest
    # needs: test
    permissions:
      id-token: write
      contents: read
    
    outputs:
      image-tag: ${{ steps.image-tag.outputs.tag }}
      image-uri: ${{ steps.build-image.outputs.image }}

    steps:
      # ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout code
        uses: actions/checkout@v4

      # Java 17 ì„¤ì • (Spring Boot ë¹Œë“œìš©)
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # Gradle ì˜ì¡´ì„± ìºì‹±
      # ëª©ì : build.gradle ë³€ê²½ ì—†ìœ¼ë©´ ì˜ì¡´ì„± ë‹¤ìš´ë¡œë“œ ìŠ¤í‚µ
      - name: Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      # Gradle wrapper ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew

      # ì˜ì¡´ì„± ì‚¬ì „ ë‹¤ìš´ë¡œë“œ (Docker ë¹Œë“œ ì „ ìºì‹œ ì¤€ë¹„)
      - name: Download dependencies
        run: ./gradlew dependencies --no-daemon || true

      # AWS ì¸ì¦ (OIDC ë°©ì‹, ë³´ì•ˆ ê°•í™”)
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.DEV_IAM_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-UserCI
          audience: sts.amazonaws.com

      # ECR ë¡œê·¸ì¸ (Docker ì´ë¯¸ì§€ í‘¸ì‹œìš©)
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      # ì´ë¯¸ì§€ íƒœê·¸ ìƒì„± (dev-{commit-sha} í˜•ì‹)
      - name: Set image tag
        id: image-tag
        run: echo "tag=dev-${{ github.sha }}" >> $GITHUB_OUTPUT

      # Docker Buildx ì„¤ì • (ë ˆì´ì–´ ìºì‹œ ë° ë©€í‹° í”Œë«í¼ ë¹Œë“œ ì§€ì›)
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # ë¹Œë“œ ì‹œì‘ ì‹œê°„ ê¸°ë¡ (ì„±ëŠ¥ ì¸¡ì •ìš©)
      - name: Record build start time
        id: build-start
        run: echo "time=$(date +%s)" >> $GITHUB_OUTPUT

      # Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° ECR í‘¸ì‹œ
      # ëª©ì : ìµœì í™”ëœ ì´ë¯¸ì§€ ìƒì„± ë° ë ˆì´ì–´ ìºì‹œ í™œìš©
      - name: Build and push Docker image
        id: build-image
        uses: docker/build-push-action@v5
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ steps.image-tag.outputs.tag }}
        with:
          context: .
          file: ${{ env.SERVICE_PATH }}/Dockerfile
          push: true
          tags: |
            ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }}
            ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:latest
          # ECR ë ˆì´ì–´ ìºì‹œ
          cache-from: type=registry,ref=${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:buildcache
          cache-to: type=registry,ref=${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:buildcache,mode=max
          build-args: |
            BUILDKIT_INLINE_CACHE=1

      # ë¹Œë“œ ì‹œê°„ ê³„ì‚° ë° ì¶œë ¥
      - name: Calculate build time
        id: build-time
        run: |
          END_TIME=$(date +%s)
          BUILD_TIME=$((END_TIME - ${{ steps.build-start.outputs.time }}))
          BUILD_TIME_MIN=$((BUILD_TIME / 60))
          BUILD_TIME_SEC=$((BUILD_TIME % 60))
          echo "seconds=$BUILD_TIME" >> $GITHUB_OUTPUT
          echo "formatted=${BUILD_TIME_MIN}ë¶„ ${BUILD_TIME_SEC}ì´ˆ" >> $GITHUB_OUTPUT

      # ECRì—ì„œ ì´ë¯¸ì§€ í¬ê¸° í™•ì¸
      - name: Check image size
        id: image-size
        run: |
          sleep 5  # ECRì— ì´ë¯¸ì§€ê°€ ì™„ì „íˆ ë“±ë¡ë  ë•Œê¹Œì§€ ëŒ€ê¸°
          
          # ECRì—ì„œ ì´ë¯¸ì§€ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
          IMAGE_DETAILS=$(aws ecr describe-images \
            --repository-name ${{ env.ECR_REPOSITORY }} \
            --image-ids imageTag=${{ steps.image-tag.outputs.tag }} \
            --query 'imageDetails[0].imageSizeInBytes' \
            --output text 2>/dev/null || echo "0")
          
          if [ "$IMAGE_DETAILS" != "0" ] && [ "$IMAGE_DETAILS" != "None" ]; then
            # ë°”ì´íŠ¸ë¥¼ MBë¡œ ë³€í™˜
            SIZE_MB=$(echo "scale=2; $IMAGE_DETAILS / 1024 / 1024" | bc)
            echo "size=${SIZE_MB}MB" >> $GITHUB_OUTPUT
          else
            echo "size=ì¸¡ì • ì¤‘..." >> $GITHUB_OUTPUT
          fi

      # GitHub Actions Summaryì— ë¹Œë“œ ë©”íŠ¸ë¦­ í‘œì‹œ
      # ëª©ì : ë¹Œë“œ ì‹œê°„, ì´ë¯¸ì§€ í¬ê¸°, ìµœì í™” íš¨ê³¼ ì‹œê°í™”
      - name: Generate build summary
        if: always()
        run: |
          # ì´ë¯¸ì§€ í¬ê¸° í¬ë§·íŒ…
          IMAGE_SIZE="${{ steps.image-size.outputs.size }}"
          if [ "$IMAGE_SIZE" = "N/A" ] || [ -z "$IMAGE_SIZE" ]; then
            IMAGE_SIZE="ì¸¡ì • ì¤‘..."
          fi
          
          # ë¹Œë“œ ìƒíƒœ ì´ëª¨ì§€
          if [ "${{ job.status }}" = "success" ]; then
            STATUS_EMOJI="âœ…"
            STATUS_TEXT="ì„±ê³µ"
          else
            STATUS_EMOJI="âŒ"
            STATUS_TEXT="ì‹¤íŒ¨"
          fi
          
          cat >> $GITHUB_STEP_SUMMARY <<EOF
          ## ğŸš€ User Service ë¹Œë“œ ê²°ê³¼ ${STATUS_EMOJI}
          
          ### ğŸ“Š ë¹Œë“œ ë©”íŠ¸ë¦­
          
          | í•­ëª© | ê°’ |
          |------|-----|
          | ğŸ¯ ë¹Œë“œ ìƒíƒœ | **${STATUS_TEXT}** |
          | â±ï¸ ë¹Œë“œ ì‹œê°„ | **${{ steps.build-time.outputs.formatted }}** (${{ steps.build-time.outputs.seconds }}ì´ˆ) |
          | ğŸ“¦ ì´ë¯¸ì§€ í¬ê¸° | **${IMAGE_SIZE}** |
          | ğŸ·ï¸ ì´ë¯¸ì§€ íƒœê·¸ | \`${{ steps.image-tag.outputs.tag }}\` |
          | ğŸ’¾ ìºì‹œ ì „ëµ | ECR Registry Cache |
          | ğŸ”§ ë¹Œë“œ ë„êµ¬ | Docker Buildx + Gradle 8.5 |
          | ğŸ³ ë² ì´ìŠ¤ ì´ë¯¸ì§€ | eclipse-temurin:17-jre-alpine |

          
          ### ğŸ”— ì´ë¯¸ì§€ ì •ë³´
          
          \`\`\`
          ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ steps.image-tag.outputs.tag }}
          \`\`\`
          
          ### ğŸ“ ECRì—ì„œ ì •í™•í•œ í¬ê¸° í™•ì¸
          
          \`\`\`bash
          aws ecr describe-images \\
            --repository-name ${{ env.ECR_REPOSITORY }} \\
            --image-ids imageTag=${{ steps.image-tag.outputs.tag }} \\
            --query 'imageDetails[0].imageSizeInBytes' \\
            --output text | awk '{printf "%.2f MB\n", \$1/1024/1024}'
          \`\`\`
          

      # ì´ë¯¸ì§€ URI ì¶œë ¥ (ë‹¤ë¥¸ jobì—ì„œ ì‚¬ìš© ê°€ëŠ¥)
      - name: Set image output
        run: echo "image=${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ steps.image-tag.outputs.tag }}" >> $GITHUB_OUTPUT

      # Discord ì•Œë¦¼ - ì„±ê³µ ì‹œ
      # ëª©ì : íŒ€ì—ê²Œ ë¹Œë“œ ì™„ë£Œ ë° ë©”íŠ¸ë¦­ ê³µìœ 
      - name: Notify Discord - CI Success
        run: |
          # ì´ë¯¸ì§€ í¬ê¸° í¬ë§·íŒ…
          IMAGE_SIZE="${{ steps.image-size.outputs.size }}"
          if [ "$IMAGE_SIZE" = "N/A" ] || [ -z "$IMAGE_SIZE" ]; then
            IMAGE_SIZE="ì¸¡ì • ì¤‘ (ECR í™•ì¸)"
          fi
          
          curl -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{
              "embeds": [{
                "title": "âœ… Dev CI ì„±ê³µ - User ì„œë¹„ìŠ¤",
                "description": "**í™˜ê²½:** Dev\n**ì„œë¹„ìŠ¤:** user-service\n**ë¸Œëœì¹˜:** develop\n**ì»¤ë°‹:** `${{ github.sha }}`\n**ì´ë¯¸ì§€:** `${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ steps.image-tag.outputs.tag }}`",
                "color": 3066993,
                "fields": [
                  {
                    "name": "â±ï¸ ë¹Œë“œ ì‹œê°„",
                    "value": "${{ steps.build-time.outputs.formatted }}",
                    "inline": true
                  },
                  {
                    "name": "ğŸ“¦ ì´ë¯¸ì§€ í¬ê¸°",
                    "value": "'"$IMAGE_SIZE"'",
                    "inline": true
                  },
                  {
                    "name": "ğŸ¯ ìµœì í™”",
                    "value": "Alpine ê¸°ë°˜ (~280MB ëª©í‘œ)",
                    "inline": true
                  }
                ],
                "footer": {
                  "text": "ğŸ’¾ ECR ë ˆì´ì–´ ìºì‹œ í™œìš© | ğŸ³ eclipse-temurin:17-jre-alpine"
                },
                "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"
              }]
            }'

      # Discord ì•Œë¦¼ - ì‹¤íŒ¨ ì‹œ
      # ëª©ì : ë¹Œë“œ ì‹¤íŒ¨ë¥¼ íŒ€ì—ê²Œ ì¦‰ì‹œ ì•Œë¦¼
      - name: Notify Discord - CI Failed
        if: failure()
        run: |
          curl -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{
              "embeds": [{
                "title": "âŒ Dev CI ì‹¤íŒ¨ - User ì„œë¹„ìŠ¤",
                "description": "**í™˜ê²½:** Dev\n**ì„œë¹„ìŠ¤:** user-service\n**ë¸Œëœì¹˜:** develop\n**ì»¤ë°‹:** `${{ github.sha }}`\n**ì‹¤íŒ¨ ì›ì¸:** ë¹Œë“œ ë˜ëŠ” í‘¸ì‹œ ì‹¤íŒ¨",
                "color": 15158332,
                "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"
              }]
            }'
