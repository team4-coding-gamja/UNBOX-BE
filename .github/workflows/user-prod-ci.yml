name: User Service - Prod CI

on:
  push:
    branches:
      - main
    paths:
      - 'unbox_user/**'
      - 'unbox_common/**'
      - '.github/workflows/user-prod-ci.yml'

  workflow_dispatch:

env:
  AWS_REGION: ap-northeast-2
  ECR_REPOSITORY: unbox-prod-user-repo
  SERVICE_NAME: user-service
  SERVICE_PATH: unbox_user

jobs:
  # ============================================
  # Manual Approval Gate
  # ============================================
  approval:
    name: Manual Approval Required
    runs-on: ubuntu-latest
    environment:
      name: production-ci-approval
    
    steps:
      - name: Notify Discord - Approval Required
        run: |
          curl -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{
              "embeds": [{
                "title": "â¸ï¸ Prod CI ìŠ¹ì¸ ëŒ€ê¸° - User ì„œë¹„ìŠ¤",
                "description": "**í™˜ê²½:** Production\n**ì„œë¹„ìŠ¤:** user-service\n**ë¸Œëœì¹˜:** main\n**ì»¤ë°‹:** `${{ github.sha }}`\n\n**ìŠ¹ì¸ í•„ìš”:** GitHub Actionsì—ì„œ ìˆ˜ë™ ìŠ¹ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.",
                "color": 16776960,
                "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"
              }]
            }'

  # ============================================
  # Build and Push Docker Image
  # ============================================
  build:
    name: Build and Push Image
    runs-on: ubuntu-latest
    needs: approval
    permissions:
      id-token: write
      contents: read
    
    outputs:
      image-tag: ${{ steps.image-tag.outputs.tag }}
      image-uri: ${{ steps.build-image.outputs.image }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew

      - name: Download dependencies
        run: ./gradlew dependencies --no-daemon || true

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.PROD_IAM_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-UserProdCI
          audience: sts.amazonaws.com

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set image tag
        id: image-tag
        run: echo "tag=prod-${{ github.sha }}" >> $GITHUB_OUTPUT

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Record build start time
        id: build-start
        run: echo "time=$(date +%s)" >> $GITHUB_OUTPUT

      - name: Build and push Docker image
        id: build-image
        uses: docker/build-push-action@v5
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ steps.image-tag.outputs.tag }}
        with:
          context: .
          file: ${{ env.SERVICE_PATH }}/Dockerfile
          push: true
          tags: |
            ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }}
            ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:latest
          cache-from: type=registry,ref=${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:buildcache
          cache-to: type=registry,ref=${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:buildcache,mode=max
          build-args: |
            BUILDKIT_INLINE_CACHE=1

      - name: Calculate build time
        id: build-time
        run: |
          END_TIME=$(date +%s)
          BUILD_TIME=$((END_TIME - ${{ steps.build-start.outputs.time }}))
          BUILD_TIME_MIN=$((BUILD_TIME / 60))
          BUILD_TIME_SEC=$((BUILD_TIME % 60))
          echo "seconds=$BUILD_TIME" >> $GITHUB_OUTPUT
          echo "formatted=${BUILD_TIME_MIN}ë¶„ ${BUILD_TIME_SEC}ì´ˆ" >> $GITHUB_OUTPUT

      - name: Check image size
        id: image-size
        run: |
          sleep 5
          IMAGE_DETAILS=$(aws ecr describe-images \
            --repository-name ${{ env.ECR_REPOSITORY }} \
            --image-ids imageTag=${{ steps.image-tag.outputs.tag }} \
            --query 'imageDetails[0].imageSizeInBytes' \
            --output text 2>/dev/null || echo "0")
          
          if [ "$IMAGE_DETAILS" != "0" ] && [ "$IMAGE_DETAILS" != "None" ]; then
            SIZE_MB=$(echo "scale=2; $IMAGE_DETAILS / 1024 / 1024" | bc)
            echo "size=${SIZE_MB}MB" >> $GITHUB_OUTPUT
          else
            echo "size=ì¸¡ì • ì¤‘..." >> $GITHUB_OUTPUT
          fi

      - name: Generate build summary
        if: always()
        run: |
          IMAGE_SIZE="${{ steps.image-size.outputs.size }}"
          if [ "$IMAGE_SIZE" = "N/A" ] || [ -z "$IMAGE_SIZE" ]; then
            IMAGE_SIZE="ì¸¡ì • ì¤‘..."
          fi
          
          if [ "${{ job.status }}" = "success" ]; then
            STATUS_EMOJI="âœ…"
            STATUS_TEXT="ì„±ê³µ"
          else
            STATUS_EMOJI="âŒ"
            STATUS_TEXT="ì‹¤íŒ¨"
          fi
          
          cat >> $GITHUB_STEP_SUMMARY <<EOF
          ## ğŸš€ User Service Prod ë¹Œë“œ ê²°ê³¼ ${STATUS_EMOJI}
          
          ### ğŸ“Š ë¹Œë“œ ë©”íŠ¸ë¦­
          
          | í•­ëª© | ê°’ |
          |------|-----|
          | ğŸ¯ ë¹Œë“œ ìƒíƒœ | **${STATUS_TEXT}** |
          | ğŸŒ í™˜ê²½ | **Production** |
          | â±ï¸ ë¹Œë“œ ì‹œê°„ | **${{ steps.build-time.outputs.formatted }}** |
          | ğŸ“¦ ì´ë¯¸ì§€ í¬ê¸° | **${IMAGE_SIZE}** |
          | ğŸ·ï¸ ì´ë¯¸ì§€ íƒœê·¸ | \`${{ steps.image-tag.outputs.tag }}\` |
          
          ### ğŸ”— ì´ë¯¸ì§€ ì •ë³´
          
          \`\`\`
          ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ steps.image-tag.outputs.tag }}
          \`\`\`
          EOF

      - name: Set image output
        run: echo "image=${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ steps.image-tag.outputs.tag }}" >> $GITHUB_OUTPUT

      - name: Notify Discord - CI Success
        run: |
          IMAGE_SIZE="${{ steps.image-size.outputs.size }}"
          if [ "$IMAGE_SIZE" = "N/A" ] || [ -z "$IMAGE_SIZE" ]; then
            IMAGE_SIZE="ì¸¡ì • ì¤‘"
          fi
          
          curl -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{
              "embeds": [{
                "title": "âœ… Prod CI ì„±ê³µ - User ì„œë¹„ìŠ¤",
                "description": "**í™˜ê²½:** Production\n**ì„œë¹„ìŠ¤:** user-service\n**ë¸Œëœì¹˜:** main\n**ì»¤ë°‹:** `${{ github.sha }}`\n**ì´ë¯¸ì§€:** `${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ steps.image-tag.outputs.tag }}`",
                "color": 3066993,
                "fields": [
                  {
                    "name": "â±ï¸ ë¹Œë“œ ì‹œê°„",
                    "value": "${{ steps.build-time.outputs.formatted }}",
                    "inline": true
                  },
                  {
                    "name": "ğŸ“¦ ì´ë¯¸ì§€ í¬ê¸°",
                    "value": "'"$IMAGE_SIZE"'",
                    "inline": true
                  }
                ],
                "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"
              }]
            }'

      - name: Notify Discord - CI Failed
        if: failure()
        run: |
          curl -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{
              "embeds": [{
                "title": "âŒ Prod CI ì‹¤íŒ¨ - User ì„œë¹„ìŠ¤",
                "description": "**í™˜ê²½:** Production\n**ì„œë¹„ìŠ¤:** user-service\n**ë¸Œëœì¹˜:** main\n**ì»¤ë°‹:** `${{ github.sha }}`\n**ì‹¤íŒ¨ ì›ì¸:** ë¹Œë“œ ë˜ëŠ” í‘¸ì‹œ ì‹¤íŒ¨",
                "color": 15158332,
                "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"
              }]
            }'
