# ✍️ Review 도메인 (리뷰 및 평점)

## 1. 개요
구매자의 실제 상품 경험을 기록하고 평점을 관리하는 도메인입니다. 데이터의 무결성을 유지하고, 팀 프로젝트 통합 시 발생할 수 있는 대규모 조회 성능 문제를 고려하여 설계되었습니다.


## 2. 주요 기능 및 진행 상황
- [o] **리뷰 및 평점 작성**: 주문 완료 데이터를 기반으로 1~5점 사이의 평점과 후기를 기록합니다.
- [진행중] **상품별 리뷰 목록 조회**: 주문 Search 시 상품 PK값을 쿼리스트링에 담아 호출하면 해당 상품의 리뷰 리스트를 최신순으로 페이징 조회를 제공합니다.
- [진행중] **본인 확인 로직**: `@RequestHeader`를 통해 작성자 본인만 수정/삭제가 가능하도록 보안을 강화했습니다.
- [o] **소프트 딜리트(Soft Delete)**: 데이터 보존 및 분석을 위해 `deleted_at` 필드를 활용한 논리 삭제를 구현했습니다.


## 3. 기술적 의사결정
### ✅ Soft Delete 적용
- **이유**: 사용자 실수로 인한 데이터 삭제 시 복구가 가능하도록 하고, 추후 평점 통계 및 트렌드 분석을 위해 실제 데이터를 DB에서 제거하지 않는 방식을 채택했습니다.
- **구현**: `deletedAt` 필드가 `null`인 데이터만 조회하도록 Repository 레이어에서 필터링합니다.

### ✅ 인프라 구축 및 검증 (Docker & Swagger)
- **도커(Docker)**: 로컬 DB 설치 없이 PostgreSQL 컨테이너를 활용하여 독립적인 개발 환경을 구축했습니다.
- **스웨거(Swagger)**: API 명세 자동화 및 실제 데이터 입력 테스트를 통해 CRUD 전 로직의 정상 작동을 검증했습니다.

### ✅ Mockito 기반 단위 테스트 (Unit Test)
- **이유**: DB 의존성 없이 서비스 로직의 정합성을 1초 내외로 빠르게 검증하기 위해 가짜 객체(Mock)를 활용했습니다.
- **성과**: **총 4건의 시나리오**(작성 성공, 평점 예외, 타인 수정 불가, 본인 삭제 성공)를 모두 통과하여 로직의 안정성을 확보했습니다.

### ✅ 단위 테스트 결과 (ReviewServiceTest)
비즈니스 로직과 보안 로직의 정합성을 검증하기 위해 JUnit5와 Mockito를 활용한 단위 테스트를 수행했습니다.
- **테스트 시나리오**: 리뷰 수정 시 작성자(1L)와 요청자(2L)가 다를 경우 권한 예외 발생 여부 확인
- **결과**: `SecurityException` 발생 검증 완료 및 테스트 통과 (**ALL PASSED**)
- **성과**: 배포 전 발생할 수 있는 치명적인 보안 취약점(타인 게시물 수정 가능성)을 사전에 차단함.


## 4. 데이터 구조 (Entity)
- **review_id**: `UUID` (Primary Key)
- **order_id**: `UUID` (주문 정보 연결 - 현재 단순 ID 저장)
- **buyer_id**: `Long` (작성자 고유 번호)
- **content**: `Text` (리뷰 본문)
- **rating**: `Integer` (1~5점 제한)
- **image_url**: `String` (이미지 저장 경로)


## 5. 추후 수정 할 것들
### a) 상품 목록 조회 시 평점 평균 노출 (N+1 문제 해결)
    문제점 : 상품 목록 조회 시, 각 상품마다 별도로 리뷰 데이터를 조회하여 실시간으로 평점 평균을 계산할 경우 N+1 쿼리 문제가 발생하여 조회 성능이 심각하게 저하될 우려가 있습니다.
    해결 방법 : Product 엔티티에 averageRating(평점 평균)과 reviewCount(리뷰 개수) 필드를 추가하여 직접 관리하는 반정규화 방식으로 할 예정입니다.
              리뷰가 등록/수정될 때 해당 값을 갱신하고, 목록 조회 시에는 별도의 연산 없이 컬럼 값을 바로 반환하여 조회 성능을 최적화 할 예정입니다.
### b) 도메인 간 통합 및 검증 강화
    연관 관계 만들기 : 현재 UUID로 관리 중인 필드를 팀원들의 엔티티와 연동하여 JPA `@ManyToOne` 객체 참조 구조로 전환할 예정입니다.
    작성 권한 정밀 검증 : `OrderService`와의 통신(Feign Client 등)을 통해 실제 '배송 완료' 상태인 주문 건에 대해서만 리뷰 작성을 허용하도록 변경 할 예정입니다.
### c) S3 이미지 업로드 구현
    S3 설정 정보 등록 (application.yml) : 파일을 S3에 올리고,
    S3 업로드 서비스(S3Service) : 고유한 URL을 받아오는 로직 만들예정입니다.
    Controller 수정 (MultipartFile 처리) : 리뷰 작성 API에서 이미지 파일을 함께 받을 수 있도록 변경 할 예정입니다. JSON 데이터와 File을 동시에 받을 예정입니다.
### d) 임의로 선언해 놓은 것들 팀원 entity 보고 수정


## 6. API 명세
| Method | Endpoint | Description | Status |
| :--- | :--- | :--- |:-------|
| **POST** | `/api/reviews` | 리뷰 및 평점 등록 | 진행중    |
| **GET** | `/api/reviews` | 상품별 리뷰 목록 조회 (페이징) | 진행중    |
| **PATCH** | `/api/reviews/{id}` | 리뷰 수정 (작성자 본인 확인) | 진행중    |
| **DELETE** | `/api/reviews/{id}` | 리뷰 삭제 (Soft Delete) | ✅ 완료   |