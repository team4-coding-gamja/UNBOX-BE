# AWS MVP 배포용 Docker Compose
# EC2 + RDS 구성 (Spring Boot + Redis)

version: '3.8'

services:
  # Spring Boot 애플리케이션
  app:
    build: .
    container_name: unbox-mvp-app
    ports:
      - "8080:8080"  # Spring Boot 기본 포트
    environment:
      # Spring 프로파일 설정
      - SPRING_PROFILES_ACTIVE=mvp
      
      # RDS PostgreSQL 연결
      - SPRING_DATASOURCE_URL=${SPRING_DATASOURCE_URL}
      - SPRING_DATASOURCE_USERNAME=${SPRING_DATASOURCE_USERNAME}
      - SPRING_DATASOURCE_PASSWORD=${SPRING_DATASOURCE_PASSWORD}
      - SPRING_DATASOURCE_DRIVER_CLASS_NAME=${SPRING_DATASOURCE_DRIVER_CLASS_NAME}
      - SPRING_JPA_DATABASE_PLATFORM=${SPRING_JPA_DATABASE_PLATFORM}
      - SPRING_JPA_HIBERNATE_DDL_AUTO=${SPRING_JPA_HIBERNATE_DDL_AUTO}
      
      # Redis 연결 (동시주문 Lock + JWT 리프레시 토큰용)
      - SPRING_DATA_REDIS_HOST=redis
      - SPRING_DATA_REDIS_PORT=${SPRING_DATA_REDIS_PORT}
      - SPRING_DATA_REDIS_TIMEOUT=${SPRING_DATA_REDIS_TIMEOUT}
      - SPRING_DATA_REDIS_LETTUCE_POOL_MAX_ACTIVE=${SPRING_DATA_REDIS_LETTUCE_POOL_MAX_ACTIVE}
      - SPRING_DATA_REDIS_LETTUCE_POOL_MAX_IDLE=${SPRING_DATA_REDIS_LETTUCE_POOL_MAX_IDLE}
      - SPRING_DATA_REDIS_LETTUCE_POOL_MIN_IDLE=${SPRING_DATA_REDIS_LETTUCE_POOL_MIN_IDLE}
      
      # JWT 보안 설정
      - SPRING_JWT_SECRET=${SPRING_JWT_SECRET}
      - SPRING_JWT_ACCESS_TOKEN_EXPIRATION=${SPRING_JWT_ACCESS_TOKEN_EXPIRATION}
      - SPRING_JWT_REFRESH_TOKEN_EXPIRATION=${SPRING_JWT_REFRESH_TOKEN_EXPIRATION}
      
      # 서버 설정
      - SERVER_PORT=${SERVER_PORT}
      
      # 시간대 설정
      - TZ=Asia/Seoul
      
    depends_on:
      redis:
        condition: service_healthy
    
    restart: unless-stopped
    
    # Spring Boot 애플리케이션 헬스체크
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Redis 서비스 (동시주문 Lock + JWT 리프레시 토큰용)
  redis:
    image: redis:7-alpine
    container_name: unbox-mvp-redis
    ports:
      - "6379:6379"
    
    # Redis 설정 최적화 (Lock + JWT용)
    command: >
      redis-server 
      --maxmemory 512mb
      --maxmemory-policy volatile-lru
      --save 900 1
      --appendonly yes
      --appendfsync everysec
      --timeout 300
      --tcp-keepalive 60
    
    volumes:
      - redis_data:/data
    
    restart: unless-stopped
    
    # Redis 헬스체크
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

# Docker 볼륨 설정
volumes:
  redis_data:
    driver: local