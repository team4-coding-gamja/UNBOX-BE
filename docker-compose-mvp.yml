# AWS MVP 배포용 Docker Compose
# EC2 + RDS 구성 (Spring Boot + Redis)

#version: '3.8'

services:
  # Spring Boot 애플리케이션
  app:
    build: .
    container_name: unbox-mvp-app
    ports:
      - "8080:8080"  # Spring Boot 기본 포트
    env_file:
      - .env.mvp  # MVP 환경 변수 파일 사용
    environment:
      # Spring 프로파일 설정
      - SPRING_PROFILES_ACTIVE=mvp
      # 시간대 설정
      - TZ=Asia/Seoul
      
    depends_on:
      redis:
        condition: service_healthy
    
    restart: unless-stopped
    
    # Spring Boot Actuator 헬스체크
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Redis 서비스 (동시주문 Lock + JWT 리프레시 토큰용)
  redis:
    image: redis:7-alpine
    container_name: unbox-mvp-redis
    ports:
      - "6379:6379"
    
    # Redis 설정 최적화 (Lock + JWT용)
    command: >
      redis-server 
      --maxmemory 512mb
      --maxmemory-policy volatile-lru
      --save 900 1
      --appendonly yes
      --appendfsync everysec
      --timeout 300
      --tcp-keepalive 60
    
    volumes:
      - redis_data:/data
    
    restart: unless-stopped
    
    # Redis 헬스체크
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

# Docker 볼륨 설정
volumes:
  redis_data:
    driver: local