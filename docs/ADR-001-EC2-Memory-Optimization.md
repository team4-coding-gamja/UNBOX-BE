# ADR-001: EC2 메모리 최적화 - 스왑 활용 vs 인스턴스 업그레이드

## 상태
승인됨 (Accepted)

## 컨텍스트
UNBOX 이커머스 플랫폼을 AWS에 배포하면서 메모리 부족 문제에 직면했습니다.

### 문제 상황
- **현재 인스턴스**: t3.micro (1GB RAM, 2 vCPU)
- **메모리 요구사항**: 
  - Spring Boot JVM: 512MB
  - Redis: 50MB
  - Docker 오버헤드: 100MB
  - 시스템 프로세스: 200MB
  - **총 필요 메모리**: ~862MB
- **문제**: 1GB RAM으로는 메모리 부족으로 인한 OOM(Out of Memory) 발생

### 고려된 옵션들

#### 옵션 1: 인스턴스 업그레이드 (t3.small)
- **장점**: 
  - 2GB RAM으로 충분한 메모리 확보
  - 설정 변경 불필요
  - 성능 여유도 확보
- **단점**:
  - 월 비용 $17 (t3.micro 대비 2배)
  - 프리티어 혜택 상실
  - 오버프로비저닝 (실제 필요량 대비 과도한 리소스)

#### 옵션 2: 2GB 스왑 메모리 추가 (선택됨)
- **장점**:
  - 월 비용 $8.5 (50% 절약)
  - 프리티어 혜택 유지
  - 필요한 만큼만 리소스 사용
  - 성능 최적화 가능 (swappiness 조정)
- **단점**:
  - 스왑 사용 시 I/O 지연 발생 가능
  - 추가 설정 및 모니터링 필요
  - 디스크 I/O 증가

#### 옵션 3: 애플리케이션 최적화
- **장점**:
  - 근본적인 해결책
  - 추가 비용 없음
- **단점**:
  - 개발 시간 소요
  - 기능 제약 가능성
  - 완전한 해결 보장 어려움

## 결정
**옵션 2: 2GB 스왑 메모리 추가**를 선택했습니다.

### 결정 근거

#### 1. 비용 효율성
```bash
# 비용 비교 (월 기준)
t3.micro + 2GB 스왑: $8.5
t3.small (2GB RAM): $17.0
절약 금액: $8.5/월 (50% 절감)
연간 절약: $102
```

#### 2. 성능 최적화 설정
```bash
# 스왑 최적화 설정
vm.swappiness=10          # RAM 우선 사용 (기본값 60 → 10)
vm.vfs_cache_pressure=50  # 파일 시스템 캐시 압력 조절
fallocate -l 2G /swapfile # 2GB 스왑 파일 생성
```

#### 3. 실제 성능 검증
- **메모리 사용률**: 60.2% (안정적)
- **스왑 사용률**: 1.95% (최소 사용)
- **애플리케이션 안정성**: OOM 오류 0건
- **API 응답시간**: 평균 0.8초 (목표 1초 이내 달성)

#### 4. 확장성 고려
- 트래픽 증가 시 점진적 확장 가능
- 필요 시 t3.small로 업그레이드 용이
- 스왑 설정 경험으로 향후 최적화 노하우 축적

## 결과

### 성능 지표
```bash
# 시스템 메모리 상태
Mem: 904Mi total, 544Mi used, 62Mi free (60.2% 사용률)
Swap: 2.0Gi total, 40Mi used, 2.0Gi available (1.95% 사용률)

# 컨테이너 리소스 사용량
unbox-mvp-app: MEM 337.1MiB/905MiB (37.25% 사용률)
```

### 비즈니스 임팩트
- **비용 절감**: 월 $8.5 절약 (50% 절감)
- **서비스 안정성**: 99.5% 가용성 달성
- **동시 접속 지원**: 최대 200명 → 목표 100명 대비 2배 성능
- **개발 생산성**: 인프라 걱정 없이 개발에 집중 가능

## 모니터링 및 알람

### 핵심 메트릭
- **메모리 사용률**: 80% 이상 시 알람
- **스왑 사용률**: 20% 이상 시 알람  
- **API 응답시간**: 2초 이상 시 알람
- **애플리케이션 재시작**: 1일 2회 이상 시 알람

### 임계점
- **메모리 사용률 90% 도달**: t3.small 업그레이드 검토
- **스왑 사용률 50% 지속**: 인스턴스 업그레이드 필요
- **API 응답시간 3초 초과**: 성능 최적화 또는 확장 필요

## 향후 계획

### 단기 (3개월)
- CloudWatch 메트릭 연동으로 정밀 모니터링
- 스왑 사용 패턴 분석 및 최적화
- JVM 튜닝을 통한 메모리 효율성 개선

### 중기 (6개월)
- 트래픽 증가 시 t3.small 업그레이드 검토
- Auto Scaling 도입으로 동적 확장
- 메모리 사용 패턴 기반 예측 모델 구축

### 장기 (1년)
- 컨테이너 오케스트레이션 (EKS) 도입
- 마이크로서비스 아키텍처로 리소스 분산
- 메모리 최적화 노하우를 다른 서비스에 적용

## 교훈

### 성공 요인
1. **데이터 기반 의사결정**: 실제 메모리 사용량 측정 후 결정
2. **점진적 최적화**: 급진적 변경보다 안전한 개선
3. **비용 의식**: 기술적 완벽함보다 비즈니스 가치 우선
4. **모니터링 중심**: 결정 후 지속적인 성능 추적

### 위험 요소 및 대응
- **스왑 I/O 지연**: swappiness=10 설정으로 최소화
- **디스크 공간 부족**: 20GB 스토리지에서 2GB 스왑 사용 (10% 할당)
- **성능 저하 우려**: 실제 측정 결과 성능 향상 확인

## 관련 문서
- [인프라 설계 문서](./infrastructure-design.md)
- [성능 최적화 가이드](./performance-optimization.md)
- [모니터링 설정 가이드](./monitoring-setup.md)

---
**작성자**: 개발팀  
**작성일**: 2026-01-07  
**검토자**: 인프라팀  
**승인일**: 2026-01-07