name: CD - {{SERVICE_NAME}} Production Deploy

on:
  workflow_run:
    workflows: ["CI - {{SERVICE_NAME}} Build and Push"]
    types: [completed]
    branches: [main]
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Docker image tag to deploy'
        required: true
        default: 'latest'
        type: string
      skip_approval:
        description: 'Skip manual approval (emergency deployment)'
        required: false
        default: false
        type: boolean

env:
  AWS_REGION: ap-northeast-2
  TERRAFORM_VERSION: 1.6.0

jobs:
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    # OIDC Ïù∏Ï¶ùÏùÑ ÏúÑÌïú Í∂åÌïú ÏÑ§Ï†ï
    permissions:
      id-token: write
      contents: read
    
    # Production ÌôòÍ≤Ω Î≥¥Ìò∏ (ÏàòÎèô ÏäπÏù∏ ÌïÑÏöî)
    environment:
      name: production
      url: https://api.unbox.com/{{SERVICE_NAME}}/actuator/health
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    # CIÏóêÏÑú ÏÉùÏÑ±Îêú ÎπåÎìú Ï†ïÎ≥¥ Îã§Ïö¥Î°úÎìú (workflow_runÏù∏ Í≤ΩÏö∞)
    - name: Download build info
      if: github.event_name == 'workflow_run'
      uses: actions/download-artifact@v4
      with:
        name: build-info
        github-token: ${{ secrets.GITHUB_TOKEN }}
        run-id: ${{ github.event.workflow_run.id }}
        
    - name: Load build info
      if: github.event_name == 'workflow_run'
      run: |
        if [ -f build-info.env ]; then
          cat build-info.env >> $GITHUB_ENV
          echo "Using image tag from CI: $IMAGE_TAG"
        else
          echo "IMAGE_TAG=${{ github.sha }}" >> $GITHUB_ENV
          echo "Using fallback image tag: ${{ github.sha }}"
        fi
        
    - name: Set manual image tag
      if: github.event_name == 'workflow_dispatch'
      run: |
        echo "IMAGE_TAG=${{ github.event.inputs.image_tag }}" >> $GITHUB_ENV
        echo "Using manual image tag: ${{ github.event.inputs.image_tag }}"
    
    # Production Î∞∞Ìè¨ Ï†Ñ ÌôïÏù∏ÏÇ¨Ìï≠ Ï∂úÎ†•
    - name: Pre-deployment Checklist
      run: |
        echo "üö® PRODUCTION DEPLOYMENT CHECKLIST"
        echo "=================================="
        echo "Service: {{SERVICE_NAME}}"
        echo "Environment: production"
        echo "Image Tag: ${{ env.IMAGE_TAG }}"
        echo "Deployer: ${{ github.actor }}"
        echo "Trigger: ${{ github.event_name }}"
        echo ""
        echo "‚úÖ Pre-deployment checks:"
        echo "   - Staging deployment successful"
        echo "   - Code review completed"
        echo "   - Tests passing"
        echo "   - Database migrations ready (if any)"
        echo ""
        echo "‚ö†Ô∏è  This deployment will affect PRODUCTION users!"
    
    # OIDCÎ•º ÏÇ¨Ïö©Ìïú AWS Ïù∏Ï¶ù
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/github-actions-{{SERVICE_NAME}}-prod-role
        aws-region: ${{ env.AWS_REGION }}
        
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TERRAFORM_VERSION }}
        
    # ProductionÏö© Terraform ÎîîÎ†âÌÜ†Î¶¨ ÏÇ¨Ïö©
    - name: Terraform Init
      working-directory: terraform/production
      run: |
        terraform init \
          -backend-config="bucket=terraform-state-bucket" \
          -backend-config="key=services/{{SERVICE_NAME}}/production/terraform.tfstate" \
          -backend-config="region=${{ env.AWS_REGION }}"
          
    - name: Terraform Plan
      working-directory: terraform/production
      run: |
        terraform plan \
          -var="image_tag=${{ env.IMAGE_TAG }}" \
          -var="service_name={{SERVICE_NAME}}" \
          -var="environment=production" \
          -out=tfplan
          
    # Blue/Green Î∞∞Ìè¨Î•º ÏúÑÌïú ÌòÑÏû¨ ÏÉÅÌÉú Î∞±ÏóÖ
    - name: Backup Current State
      working-directory: terraform/production
      run: |
        echo "üìã Current production state:"
        terraform show -json > current-state.json
        
        # ÌòÑÏû¨ Ïã§Ìñâ Ï§ëÏù∏ ÌÉúÏä§ÌÅ¨ Ï†ïÎ≥¥ Ï†ÄÏû•
        aws ecs describe-services \
          --cluster unbox-prod-cluster \
          --services unbox-{{SERVICE_NAME}}-production \
          --query 'services[0].taskDefinition' \
          --output text > current-task-definition.txt
          
        echo "Current task definition: $(cat current-task-definition.txt)"
        
    - name: Terraform Apply
      working-directory: terraform/production
      run: terraform apply -auto-approve tfplan
      
    # Î∞∞Ìè¨ ÌõÑ ÏÉÅÏÑ∏ Ìó¨Ïä§ Ï≤¥ÌÅ¨ (ProductionÏùÄ Îçî ÏóÑÍ≤©)
    - name: Production Health Check
      run: |
        echo "‚è≥ Waiting for production service to be ready..."
        sleep 60  # ProductionÏùÄ Îçî Ïò§Îûò ÎåÄÍ∏∞
        
        HEALTH_URL="https://api.unbox.com/{{SERVICE_NAME}}/actuator/health"
        MAX_ATTEMPTS=15  # ProductionÏùÄ Îçî ÎßéÏùÄ Ïû¨ÏãúÎèÑ
        ATTEMPT=1
        
        while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
          echo "üîç Production health check attempt $ATTEMPT/$MAX_ATTEMPTS"
          
          # Îçî ÏÉÅÏÑ∏Ìïú Ìó¨Ïä§ Ï≤¥ÌÅ¨
          RESPONSE=$(curl -s -w "%{http_code}" "$HEALTH_URL" -o /tmp/health_response.json)
          HTTP_CODE="${RESPONSE: -3}"
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "‚úÖ Health check passed!"
            echo "üåê Service URL: $HEALTH_URL"
            echo "üìä Health response:"
            cat /tmp/health_response.json | jq '.' 2>/dev/null || cat /tmp/health_response.json
            break
          else
            if [ $ATTEMPT -eq $MAX_ATTEMPTS ]; then
              echo "‚ùå Production health check failed after $MAX_ATTEMPTS attempts"
              echo "HTTP Code: $HTTP_CODE"
              echo "Response: $(cat /tmp/health_response.json 2>/dev/null || echo 'No response')"
              echo ""
              echo "üö® PRODUCTION DEPLOYMENT FAILED!"
              echo "üîÑ Automatic rollback will be initiated..."
              exit 1
            fi
            echo "‚è≥ Health check failed (HTTP: $HTTP_CODE), retrying in 20 seconds..."
            sleep 20
          fi
          
          ATTEMPT=$((ATTEMPT + 1))
        done
        
    # Ï∂îÍ∞Ä Í≤ÄÏ¶ù (Production Ï†ÑÏö©)
    - name: Production Validation
      run: |
        echo "üîç Running additional production validations..."
        
        # ECS ÏÑúÎπÑÏä§ ÏÉÅÌÉú ÌôïÏù∏
        SERVICE_STATUS=$(aws ecs describe-services \
          --cluster unbox-prod-cluster \
          --services unbox-{{SERVICE_NAME}}-production \
          --query 'services[0].status' \
          --output text)
          
        if [ "$SERVICE_STATUS" != "ACTIVE" ]; then
          echo "‚ùå ECS service is not ACTIVE: $SERVICE_STATUS"
          exit 1
        fi
        
        # Ïã§Ìñâ Ï§ëÏù∏ ÌÉúÏä§ÌÅ¨ Ïàò ÌôïÏù∏
        RUNNING_COUNT=$(aws ecs describe-services \
          --cluster unbox-prod-cluster \
          --services unbox-{{SERVICE_NAME}}-production \
          --query 'services[0].runningCount' \
          --output text)
          
        DESIRED_COUNT=$(aws ecs describe-services \
          --cluster unbox-prod-cluster \
          --services unbox-{{SERVICE_NAME}}-production \
          --query 'services[0].desiredCount' \
          --output text)
          
        if [ "$RUNNING_COUNT" != "$DESIRED_COUNT" ]; then
          echo "‚ùå Running count ($RUNNING_COUNT) doesn't match desired count ($DESIRED_COUNT)"
          exit 1
        fi
        
        echo "‚úÖ All production validations passed!"
        echo "   Service Status: $SERVICE_STATUS"
        echo "   Running Tasks: $RUNNING_COUNT/$DESIRED_COUNT"
        
    # Î∞∞Ìè¨ ÏÑ±Í≥µ ÏïåÎ¶º
    - name: Production Deployment Success
      if: success()
      run: |
        echo "üéâ PRODUCTION DEPLOYMENT SUCCESSFUL!"
        echo "=================================="
        echo ""
        echo "üìã Deployment Details:"
        echo "   Service: {{SERVICE_NAME}}"
        echo "   Environment: production"
        echo "   Image Tag: ${{ env.IMAGE_TAG }}"
        echo "   Deployed by: ${{ github.actor }}"
        echo "   Deployment Time: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
        echo ""
        echo "üåê Production URLs:"
        echo "   Health Check: https://api.unbox.com/{{SERVICE_NAME}}/actuator/health"
        echo "   Service API: https://api.unbox.com/{{SERVICE_NAME}}/"
        echo ""
        echo "üîç Monitoring:"
        echo "   ECS Console: https://console.aws.amazon.com/ecs/home?region=${{ env.AWS_REGION }}#/clusters/unbox-prod-cluster/services"
        echo "   CloudWatch Logs: https://console.aws.amazon.com/cloudwatch/home?region=${{ env.AWS_REGION }}#logsV2:log-groups/log-group/%2Fecs%2F{{SERVICE_NAME}}-production"
        echo "   CloudWatch Metrics: https://console.aws.amazon.com/cloudwatch/home?region=${{ env.AWS_REGION }}#metricsV2:graph=~();search={{SERVICE_NAME}}"
        
    # Î∞∞Ìè¨ Ïã§Ìå® Ïãú ÏûêÎèô Î°§Î∞±
    - name: Auto Rollback on Failure
      if: failure()
      working-directory: terraform/production
      run: |
        echo "üö® PRODUCTION DEPLOYMENT FAILED!"
        echo "üîÑ Initiating automatic rollback..."
        
        if [ -f current-task-definition.txt ]; then
          PREVIOUS_TASK_DEF=$(cat current-task-definition.txt)
          echo "Rolling back to: $PREVIOUS_TASK_DEF"
          
          # Ïù¥Ï†Ñ ÌÉúÏä§ÌÅ¨ Ï†ïÏùòÎ°ú Î°§Î∞±
          aws ecs update-service \
            --cluster unbox-prod-cluster \
            --service unbox-{{SERVICE_NAME}}-production \
            --task-definition "$PREVIOUS_TASK_DEF" \
            --force-new-deployment
            
          echo "‚úÖ Rollback initiated. Please monitor the service status."
        else
          echo "‚ùå Cannot find previous task definition for rollback"
          echo "üîß Manual intervention required!"
        fi
        
        echo ""
        echo "üÜò IMMEDIATE ACTIONS REQUIRED:"
        echo "   1. Check ECS service status"
        echo "   2. Monitor application logs"
        echo "   3. Verify rollback completion"
        echo "   4. Notify the team"