# π—οΈ UNBOX Terraform Infrastructure

> AWS μΈν”„λΌλ¥Ό μ½”λ“λ΅ κ΄€λ¦¬ν•λ” Terraform κµ¬μ„±

## π“‹ κ°μ”

UNBOX ν”„λ΅μ νΈμ AWS μΈν”„λΌλ¥Ό TerraformμΌλ΅ μ •μν•κ³  κ΄€λ¦¬ν•©λ‹λ‹¤.
λ¨λ“ν™”λ κµ¬μ΅°λ΅ μ¬μ‚¬μ©μ„±κ³Ό μ μ§€λ³΄μμ„±μ„ λ†’μ€μµλ‹λ‹¤.

## π›οΈ μ•„ν‚¤ν…μ²

```
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
β”‚                    VPC (10.0.0.0/16)                   β”‚
β”‚                                                         β”‚
β”‚  β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”    β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β” β”‚
β”‚  β”‚  Public Subnet  β”‚    β”‚     Private Subnets         β”‚ β”‚
β”‚  β”‚  (10.0.1.0/24)  β”‚    β”‚  A: 10.0.2.0/24            β”‚ β”‚
β”‚  β”‚                 β”‚    β”‚  C: 10.0.3.0/24            β”‚ β”‚
β”‚  β”‚  β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”  β”‚    β”‚                             β”‚ β”‚
β”‚  β”‚  β”‚    EC2    β”‚  β”‚    β”‚  β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”    β”‚ β”‚
β”‚  β”‚  β”‚ (t3.micro)β”‚  β”‚    β”‚  β”‚   RDS PostgreSQL    β”‚    β”‚ β”‚
β”‚  β”‚  β”‚+ EIP      β”‚  β”‚    β”‚  β”‚   (μ΅°κ±΄λ¶€ μƒμ„±)      β”‚    β”‚ β”‚
β”‚  β”‚  β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”  β”‚    β”‚  β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”    β”‚ β”‚
β”‚  β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”    β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β” β”‚
β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
                    β†“
              β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
              β”‚ S3 + CDN    β”‚
              β”‚ - Images    β”‚
              β”‚ - Frontend  β”‚
              β”‚ - Logs      β”‚
              β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
```

## π“ λ””λ ‰ν† λ¦¬ κµ¬μ΅°

```
terraform/
β”β”€β”€ environments/          # ν™κ²½λ³„ μ„¤μ •
β”‚   β”β”€β”€ dev/              # κ°λ° ν™κ²½
β”‚   β”β”€β”€ stage/            # μ¤ν…μ΄μ§• ν™κ²½
β”‚   β””β”€β”€ prod/             # ν”„λ΅λ•μ… ν™κ²½
β””β”€β”€ modules/              # μ¬μ‚¬μ© κ°€λ¥ν• λ¨λ“
    β”β”€β”€ vpc/              # λ„¤νΈμ›ν¬ μΈν”„λΌ
    β”β”€β”€ compute/          # EC2 μΈμ¤ν„΄μ¤
    β”β”€β”€ database/         # RDS λ°μ΄ν„°λ² μ΄μ¤
    β”β”€β”€ security/         # λ³΄μ• κ·Έλ£Ή
    β””β”€β”€ storage/          # S3 + CloudFront
```

## π€ λΉ λ¥Έ μ‹μ‘

### 1. μ‚¬μ „ μ¤€λΉ„

```bash
# Terraform μ„¤μΉ ν™•μΈ
terraform --version

# AWS CLI μ„¤μ •
aws configure
```

### 2. SSH ν‚¤ μƒμ„±

```bash
# SSH ν‚¤ νμ–΄ μƒμ„±
ssh-keygen -t rsa -b 4096 -f ~/.ssh/unbox-key

# κ³µκ°ν‚¤ ν™•μΈ
cat ~/.ssh/unbox-key.pub
```

### 3. ν™κ²½ μ„¤μ •

```bash
# κ°λ° ν™κ²½ λ””λ ‰ν† λ¦¬λ΅ μ΄λ™
cd terraform/environments/dev

# λ³€μ νμΌ μƒμ„±
cp terraform.tfvars.example terraform.tfvars

# λ³€μ νμΌ νΈμ§‘
vim terraform.tfvars
```

### 4. μΈν”„λΌ λ°°ν¬

```bash
# Terraform μ΄κΈ°ν™”
terraform init

# μ‹¤ν–‰ κ³„ν ν™•μΈ
terraform plan

# μΈν”„λΌ λ°°ν¬
terraform apply
```

## β™οΈ ν™κ²½ λ³€μ μ„¤μ •

### terraform.tfvars μμ‹

```hcl
# ν”„λ΅μ νΈ μ„¤μ •
project_name = "unbox-dev"

# SSH κ³µκ°ν‚¤ (ν•„μ)
public_key = "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQ... your-key-here"

# RDS μ‚¬μ© μ—¬λ¶€ (λΉ„μ© μ μ•½: false = H2 DB μ‚¬μ©)
use_rds = false
```

## π’° λΉ„μ© μµμ ν™”

### ν”„λ¦¬ν‹°μ–΄ ν™μ©
- **EC2**: t3.micro (μ›” 750μ‹κ°„ λ¬΄λ£)
- **RDS**: db.t3.micro (μ›” 750μ‹κ°„ λ¬΄λ£)
- **S3**: 5GB λ¬΄λ£
- **CloudFront**: 1TB λ¬΄λ£

### κ°λ° ν™κ²½ λΉ„μ© μ μ•½
```hcl
# H2 μΈλ©”λ¨λ¦¬ DB μ‚¬μ© (RDS λΉ„μ© 0μ›)
use_rds = false

# ν•„μ”μ‹μ—λ§ RDS ν™μ„±ν™”
use_rds = true
```

## π”§ μ£Όμ” λ¨λ“

### VPC λ¨λ“
- **μ©λ„**: λ„¤νΈμ›ν¬ κΈ°λ° μΈν”„λΌ
- **κµ¬μ„±**: VPC, μ„λΈλ„·, λΌμ°ν… ν…μ΄λΈ”
- **νΉμ§•**: Multi-AZ κ³ κ°€μ©μ„±

### Compute λ¨λ“
- **μ©λ„**: μ• ν”λ¦¬μΌ€μ΄μ… μ„λ²„
- **κµ¬μ„±**: EC2, Elastic IP, SSH ν‚¤
- **νΉμ§•**: Docker ν™κ²½ μλ™ κµ¬μ„±

### Database λ¨λ“
- **μ©λ„**: λ°μ΄ν„° μ €μ¥μ†
- **κµ¬μ„±**: RDS PostgreSQL (μ΅°κ±΄λ¶€)
- **νΉμ§•**: λΉ„μ© μ μ•½μ„ μ„ν• H2 λ€μ•

### Security λ¨λ“
- **μ©λ„**: λ„¤νΈμ›ν¬ λ³΄μ•
- **κµ¬μ„±**: Security Groups
- **νΉμ§•**: μµμ† κ¶ν• μ›μΉ™

### Storage λ¨λ“
- **μ©λ„**: νμΌ μ €μ¥ λ° CDN
- **κµ¬μ„±**: S3 λ²„ν‚·, CloudFront
- **νΉμ§•**: React SPA μµμ ν™”

## π› οΈ μ΄μ κ°€μ΄λ“

### μΈν”„λΌ μ—…λ°μ΄νΈ
```bash
# λ³€κ²½μ‚¬ν•­ ν™•μΈ
terraform plan

# λ³€κ²½μ‚¬ν•­ μ μ©
terraform apply

# νΉμ • λ¦¬μ†μ¤λ§ μ—…λ°μ΄νΈ
terraform apply -target=module.compute
```

### μΈν”„λΌ μ‚­μ 
```bash
# μ „μ²΄ μΈν”„λΌ μ‚­μ 
terraform destroy

# νΉμ • λ¦¬μ†μ¤λ§ μ‚­μ 
terraform destroy -target=module.database
```

### μƒνƒ κ΄€λ¦¬
```bash
# μƒνƒ ν™•μΈ
terraform show

# λ¦¬μ†μ¤ λ©λ΅
terraform state list

# νΉμ • λ¦¬μ†μ¤ μƒνƒ
terraform state show aws_instance.web
```

## π”’ λ³΄μ• κ³ λ ¤μ‚¬ν•­

### ν”„λ΅λ•μ… ν™κ²½
- SSH μ ‘κ·Όμ„ νΉμ • IPλ΅ μ ν•
- RDS λΉ„λ°€λ²νΈ κ°•ν™”
- S3 λ²„ν‚· μ•”νΈν™” ν™μ„±ν™”
- CloudTrail λ΅κΉ… μ„¤μ •

### κ°λ° ν™κ²½
- λ¶ν•„μ”ν• λ¦¬μ†μ¤ μ •κΈ° μ •λ¦¬
- λΉ„μ© μ•λ¦Ό μ„¤μ •
- νƒκ·Έ κΈ°λ° λ¦¬μ†μ¤ κ΄€λ¦¬

## π“ λ¨λ‹ν„°λ§

### λΉ„μ© μ¶”μ 
```bash
# AWS CLIλ΅ λΉ„μ© ν™•μΈ
aws ce get-cost-and-usage \
  --time-period Start=2024-01-01,End=2024-01-31 \
  --granularity MONTHLY \
  --metrics BlendedCost
```

### λ¦¬μ†μ¤ μƒνƒ
- AWS Consoleμ—μ„ λ¦¬μ†μ¤ μƒνƒ ν™•μΈ
- CloudWatch λ©”νΈλ¦­ λ¨λ‹ν„°λ§
- μ •κΈ°μ μΈ λ³΄μ• κ²€ν† 

## π¨ λ¬Έμ  ν•΄κ²°

### μΌλ°μ μΈ μ¤λ¥

**1. SSH ν‚¤ μ¤λ¥**
```bash
Error: InvalidKeyPair.NotFound
```
β†’ `terraform.tfvars`μ—μ„ `public_key` κ°’ ν™•μΈ

**2. κ¶ν• μ¤λ¥**
```bash
Error: UnauthorizedOperation
```
β†’ AWS IAM κ¶ν• ν™•μΈ

**3. λ¦¬μ†μ¤ μ¶©λ**
```bash
Error: AlreadyExistsException
```
β†’ κΈ°μ΅΄ λ¦¬μ†μ¤μ™€ μ΄λ¦„ μ¶©λ, `project_name` λ³€κ²½

### λ³µκµ¬ λ°©λ²•
```bash
# μƒνƒ νμΌ λ°±μ—…
cp terraform.tfstate terraform.tfstate.backup

# κ°•μ  unlock (μ£Όμ!)
terraform force-unlock LOCK_ID

# μƒνƒ νμΌ λ³µκµ¬
terraform import aws_instance.web i-1234567890abcdef0
```


**β οΈ μ£Όμμ‚¬ν•­**
- ν”„λ΅λ•μ… λ°°ν¬ μ „ λ°λ“μ‹ `terraform plan` ν™•μΈ
- `terraform.tfvars` νμΌμ€ Gitμ— μ»¤λ°‹ν•μ§€ μ•μ
- μ •κΈ°μ μΈ μƒνƒ νμΌ λ°±μ—… κ¶μ¥