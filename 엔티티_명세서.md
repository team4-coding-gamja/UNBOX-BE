# UNBOX 엔티티 명세서

## 📋 목차
1. [공통 엔티티 (BaseEntity)](#공통-엔티티-baseentity)
2. [사용자 도메인](#사용자-도메인)
3. [관리자 도메인](#관리자-도메인)
4. [상품 도메인](#상품-도메인)
5. [주문 도메인](#주문-도메인)
6. [결제 도메인](#결제-도메인)
7. [정산 도메인](#정산-도메인)
8. [거래 도메인](#거래-도메인)
9. [장바구니 도메인](#장바구니-도메인)
10. [위시리스트 도메인](#위시리스트-도메인)
11. [리뷰 도메인](#리뷰-도메인)

---

## 공통 엔티티 (BaseEntity)

모든 엔티티가 상속받는 공통 필드

| 필드명 | 타입 | 제약조건 | 설명 |
|--------|------|----------|------|
| createdAt | LocalDateTime | NOT NULL, updatable=false | 생성 일시 |
| createdBy | String | updatable=false | 생성자 |
| updatedAt | LocalDateTime | - | 수정 일시 |
| updatedBy | String | - | 수정자 |
| deletedAt | LocalDateTime | - | 삭제 일시 (Soft Delete) |
| deletedBy | String | - | 삭제자 |

---

## 사용자 도메인

### 1. User (사용자)
**테이블명**: `p_users`

| 필드명 | 타입 | 제약조건 | 설명 |
|--------|------|----------|------|
| id | Long | PK, AUTO_INCREMENT | 사용자 ID |
| email | String | NOT NULL, UNIQUE | 이메일 (로그인 ID) |
| password | String | NOT NULL | 암호화된 비밀번호 |
| nickname | String | NOT NULL, UNIQUE, length=10 | 닉네임 (4~10자 영문 소문자, 숫자) |
| phone | String | NOT NULL | 전화번호 |

**비즈니스 규칙**:
- 닉네임: 영문 소문자와 숫자로 이루어진 4~10자
- Soft Delete 적용

---

## 관리자 도메인

### 2. Admin (관리자)
**테이블명**: `p_admin`

| 필드명 | 타입 | 제약조건 | 설명 |
|--------|------|----------|------|
| id | Long | PK, AUTO_INCREMENT | 관리자 ID |
| email | String | NOT NULL, UNIQUE | 이메일 (로그인 ID) |
| password | String | NOT NULL | 암호화된 비밀번호 |
| nickname | String | NOT NULL, UNIQUE, length=10 | 닉네임 (4~10자 영문 소문자, 숫자) |
| phone | String | NOT NULL | 전화번호 |
| adminRole | AdminRole (ENUM) | NOT NULL | 관리자 역할 |
| adminStatus | AdminStatus (ENUM) | NOT NULL | 관리자 상태 |

**ENUM - AdminRole**:
- `ROLE_MASTER`: 최고 관리자
- `ROLE_MANAGER`: 매니저
- `ROLE_INSPECTOR`: 검수자

**ENUM - AdminStatus**:
- `ACTIVE`: 활성
- `INACTIVE`: 비활성

---

## 상품 도메인

### 3. Brand (브랜드)
**테이블명**: `p_brands`

| 필드명 | 타입 | 제약조건 | 설명 |
|--------|------|----------|------|
| id | UUID | PK | 브랜드 ID |
| name | String | NOT NULL, UNIQUE | 브랜드명 (최대 50자) |
| logoUrl | String | - | 로고 URL |

**연관관계**:
- `products`: One-to-Many → Product (cascade, orphanRemoval)

---

### 4. Product (상품)
**테이블명**: `p_products`

| 필드명 | 타입 | 제약조건 | 설명 |
|--------|------|----------|------|
| id | UUID | PK | 상품 ID |
| name | String | NOT NULL | 상품명 (최대 100자) |
| modelNumber | String | - | 모델 번호 |
| category | Category (ENUM) | NOT NULL | 카테고리 |
| productImageUrl | String | - | 상품 이미지 URL |
| reviewCount | int | NOT NULL, default=0 | 리뷰 개수 |
| totalScore | int | NOT NULL, default=0 | 총 평점 합계 |
| brand | Brand | FK, NOT NULL | 브랜드 (ManyToOne) |

**ENUM - Category**:
- `SNEAKERS`: 스니커즈
- `APPAREL`: 의류
- `ACCESSORIES`: 액세서리
- 기타 카테고리...

---

### 5. ProductOption (상품 옵션)
**테이블명**: `p_product_options`

| 필드명 | 타입 | 제약조건 | 설명 |
|--------|------|----------|------|
| id | UUID | PK | 상품 옵션 ID |
| option | String | NOT NULL | 옵션 값 (예: 사이즈, 최대 50자) |
| product | Product | FK, NOT NULL | 상품 (ManyToOne) |

---

## 주문 도메인

### 6. Order (주문)
**테이블명**: `p_orders`

| 필드명 | 타입 | 제약조건 | 설명 |
|--------|------|----------|------|
| id | UUID | PK | 주문 ID |
| sellingBidId | UUID | NOT NULL | 판매 입찰 ID |
| buyer | User | FK, NOT NULL | 구매자 (ManyToOne) |
| seller | User | FK, NOT NULL | 판매자 (ManyToOne) |
| productOptionId | UUID | NOT NULL | 상품 옵션 ID |
| productId | UUID | NOT NULL | 상품 ID |
| **[스냅샷]** productName | String | NOT NULL | 상품명 (주문 시점) |
| **[스냅샷]** modelNumber | String | NOT NULL | 모델 번호 (주문 시점) |
| **[스냅샷]** productOptionName | String | NOT NULL | 상품 옵션명 (주문 시점) |
| **[스냅샷]** productImageUrl | String | - | 상품 이미지 URL (주문 시점) |
| **[스냅샷]** brandName | String | NOT NULL | 브랜드명 (주문 시점) |
| price | BigDecimal | NOT NULL | 주문 금액 |
| status | OrderStatus (ENUM) | NOT NULL | 주문 상태 |
| receiverName | String | NOT NULL, length=50 | 수령인 이름 |
| receiverPhone | String | NOT NULL, length=20 | 수령인 전화번호 |
| receiverAddress | String | NOT NULL | 수령인 주소 |
| receiverZipCode | String | NOT NULL, length=50 | 우편번호 |
| trackingNumber | String | length=100 | 운송장 번호 (판매자→센터) |
| finalTrackingNumber | String | length=100 | 최종 운송장 번호 (센터→구매자) |
| cancelledAt | LocalDateTime | - | 취소 일시 |
| completedAt | LocalDateTime | - | 완료 일시 |

**ENUM - OrderStatus**:
- `PENDING_SHIPMENT`: 발송 대기
- `SHIPPED_TO_CENTER`: 센터로 출발
- `ARRIVED_AT_CENTER`: 센터 도착
- `IN_INSPECTION`: 검수 중
- `INSPECTION_PASSED`: 검수 합격
- `INSPECTION_FAILED`: 검수 불합격
- `SHIPPED_TO_BUYER`: 구매자에게 배송 중
- `DELIVERED`: 배송 완료
- `COMPLETED`: 거래 완료
- `CANCELLED`: 취소됨

**비즈니스 규칙**:
- 주문 생성 시 상품 정보를 스냅샷으로 저장
- 상태 전환은 정해진 순서대로만 가능
- 구매 확정은 구매자만 가능

---

## 결제 도메인

### 7. Payment (결제)
**테이블명**: `p_payment`

| 필드명 | 타입 | 제약조건 | 설명 |
|--------|------|----------|------|
| id | UUID | PK | 결제 ID |
| orderId | UUID | NOT NULL, updatable=false | 주문 ID |
| amount | BigDecimal | NOT NULL | 결제 금액 |
| method | PaymentMethod (ENUM) | NOT NULL | 결제 수단 |
| pgPaymentKey | String | - | PG사 결제 키 |
| pgApproveNo | String | - | PG사 승인 번호 |
| status | PaymentStatus (ENUM) | NOT NULL | 결제 상태 |
| capturedAt | LocalDateTime | - | 결제 승인 일시 |
| version | Long | - | 낙관적 락 버전 |

**ENUM - PaymentMethod**:
- `CARD`: 카드 결제
- `BANK_TRANSFER`: 계좌 이체
- 기타...

**ENUM - PaymentStatus**:
- `READY`: 결제 준비
- `DONE`: 결제 완료
- `FAILED`: 결제 실패
- `CANCELED`: 결제 취소

---

### 8. PgTransaction (PG 거래 내역)
**테이블명**: `p_pg_transaction`

| 필드명 | 타입 | 제약조건 | 설명 |
|--------|------|----------|------|
| id | UUID | PK | PG 거래 ID |
| payment | Payment | FK, NOT NULL | 결제 (ManyToOne) |
| pgPaymentKey | String | - | PG사 결제 키 |
| pgApproveNo | String | - | PG사 승인 번호 |
| pgProvider | String | - | PG사 (예: TOSS, KAKAO) |
| eventType | String | - | 이벤트 타입 (PAYMENT, CANCEL) |
| eventStatus | PgTransactionStatus (ENUM) | - | 이벤트 상태 |
| eventAmount | BigDecimal | - | 거래 금액 |
| rawPayload | String (JSON) | - | PG사 응답 원본 (JSONB) |
| pgSellerKey | String | - | 가맹점 식별 키 |

**ENUM - PgTransactionStatus**:
- `DONE`: 완료
- `READY`: 준비
- `FAIL`: 실패

---

## 정산 도메인

### 9. Settlement (정산)
**테이블명**: `p_settlements`

| 필드명 | 타입 | 제약조건 | 설명 |
|--------|------|----------|------|
| id | UUID | PK | 정산 ID |
| orderId | UUID | NOT NULL | 주문 ID |
| sellerId | Long | NOT NULL | 판매자 ID |
| paymentId | UUID | NOT NULL | 결제 ID |
| totalAmount | BigDecimal | NOT NULL | 총 금액 |
| settlementAmount | BigDecimal | NOT NULL | 정산 금액 (수수료 제외) |
| feesAmount | BigDecimal | NOT NULL | 수수료 |
| settlementStatus | SettlementStatus (ENUM) | NOT NULL | 정산 상태 |
| sellerBankName | String | - | 판매자 은행명 |
| sellerAccountNumber | String | - | 판매자 계좌번호 |
| scheduledAt | LocalDateTime | - | 정산 예정 일시 |
| completedAt | LocalDateTime | - | 정산 완료 일시 |

**ENUM - SettlementStatus**:
- `PENDING`: 대기 중
- `DONE`: 완료
- `FAILED`: 실패

**비즈니스 규칙**:
- 결제 완료 시 정산 레코드 생성
- 구매 확정 시 정산 완료 처리

---

## 거래 도메인

### 10. SellingBid (판매 입찰)
**테이블명**: `p_selling_bids`

| 필드명 | 타입 | 제약조건 | 설명 |
|--------|------|----------|------|
| id | UUID | PK | 판매 입찰 ID |
| sellerId | Long | NOT NULL | 판매자 ID |
| productOptionId | UUID | NOT NULL | 상품 옵션 ID |
| price | BigDecimal | NOT NULL | 판매 희망 가격 |
| status | SellingStatus (ENUM) | NOT NULL, default=LIVE | 입찰 상태 |
| deadline | LocalDateTime | - | 입찰 마감 일시 |
| **[스냅샷]** productName | String | - | 상품명 |
| **[스냅샷]** modelNumber | String | - | 모델 번호 |
| **[스냅샷]** productImageUrl | String | - | 상품 이미지 URL |
| **[스냅샷]** productOptionName | String | - | 상품 옵션명 |

**ENUM - SellingStatus**:
- `LIVE`: 판매 중
- `MATCHED`: 매칭됨
- `CANCELLED`: 취소됨

**인덱스**:
- `idx_selling_option_status_price`: (product_option_id, status, price)
  - 사이즈별 최저가 조회 최적화

**비즈니스 규칙**:
- 주문 생성 시 `LIVE` → `MATCHED` 상태 변경 (동시성 제어)
- 가격 수정은 `LIVE` 상태일 때만 가능

---

## 장바구니 도메인

### 11. Cart (장바구니)
**테이블명**: `p_cart`

| 필드명 | 타입 | 제약조건 | 설명 |
|--------|------|----------|------|
| id | Long | PK, AUTO_INCREMENT | 장바구니 ID |
| user | User | FK, NOT NULL | 사용자 (ManyToOne) |
| sellingBid | SellingBid | FK, NOT NULL | 판매 입찰 (ManyToOne) |
| **[스냅샷]** productName | String | - | 상품명 |
| **[스냅샷]** productImageUrl | String | - | 상품 이미지 URL |
| **[스냅샷]** modelName | String | - | 모델명 |
| **[스냅샷]** productOptionName | String | - | 상품 옵션명 |

---

## 위시리스트 도메인

### 12. Wishlist (위시리스트)
**테이블명**: `p_wishlists`

| 필드명 | 타입 | 제약조건 | 설명 |
|--------|------|----------|------|
| id | UUID | PK | 위시리스트 ID |
| user | User | FK, NOT NULL | 사용자 (ManyToOne) |
| productOption | ProductOption | FK, NOT NULL | 상품 옵션 (ManyToOne) |

---

## 리뷰 도메인

### 13. Review (리뷰)
**테이블명**: `p_review`

| 필드명 | 타입 | 제약조건 | 설명 |
|--------|------|----------|------|
| id | UUID | PK | 리뷰 ID |
| content | String (TEXT) | NOT NULL | 리뷰 내용 (최대 1000자) |
| rating | Integer | NOT NULL | 평점 (1~5) |
| reviewImageUrl | String | - | 리뷰 이미지 URL (최대 2048자) |
| order | Order | FK, NOT NULL, UNIQUE | 주문 (OneToOne) |

**비즈니스 규칙**:
- 1주문 1리뷰 원칙 (order에 UNIQUE 제약)
- 평점은 1~5 사이 정수
- 리뷰 작성 시 Product의 reviewCount, totalScore 업데이트

---

## 📊 ERD 관계 요약

### 핵심 연관관계

```
User (1) ←→ (N) Order (구매자)
User (1) ←→ (N) Order (판매자)
User (1) ←→ (N) SellingBid
User (1) ←→ (N) Cart
User (1) ←→ (N) Wishlist

Brand (1) ←→ (N) Product
Product (1) ←→ (N) ProductOption

Order (1) ←→ (1) Review
Order (1) ←→ (1) Payment
Payment (1) ←→ (N) PgTransaction
Order (1) ←→ (1) Settlement

ProductOption (1) ←→ (N) SellingBid
ProductOption (1) ←→ (N) Wishlist

SellingBid (1) ←→ (N) Cart
```

---

## 🔑 주요 설계 원칙

### 1. Soft Delete
- 모든 엔티티는 `BaseEntity`를 상속받아 Soft Delete 지원
- `@SQLRestriction("deleted_at IS NULL")` 적용

### 2. 스냅샷 패턴
- **Order**: 주문 시점의 상품 정보 저장
- **SellingBid**: 입찰 시점의 상품 정보 저장
- **Cart**: 장바구니 추가 시점의 상품 정보 저장
- 이후 상품 정보가 변경되어도 과거 데이터 유지

### 3. 동시성 제어
- **Payment**: 낙관적 락 (`@Version`) 사용
- **SellingBid**: 상태 변경 시 원자적 업데이트 쿼리 사용

### 4. 마이크로서비스 대비
- 도메인 간 참조는 ID로 관리 (Product ↔ Order, Review 등)
- 같은 도메인 내부는 연관관계 유지 (Brand ↔ Product)

### 5. 감사(Audit) 추적
- `BaseEntity`에 생성자, 수정자, 삭제자 정보 저장
- Spring Data JPA Auditing 활용

---

**문서 생성일**: 2026-01-15  
**버전**: 1.0.0
